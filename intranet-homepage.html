<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Axero Intranet Hub</title>
  <style>
    :root {
      --primary: #2d6cdf;
      --secondary: #f5f7fa;
      --accent: #ffb400;
      --bg: #ffffff;
      --text: #222;
      --card: #f9fafc;
      --shadow: 0 2px 8px rgba(0,0,0,0.07);
      --radius: 1rem;
      --transition: 0.3s cubic-bezier(.4,0,.2,1);
    }
    [data-theme="dark"] {
      --primary: #4b8aff;
      --secondary: #23272f;
      --accent: #ffd166;
      --bg: #181c23;
      --text: #f5f7fa;
      --card: #23272f;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background var(--transition), color var(--transition);
    }
    header {
      background: var(--primary);
      color: #fff;
      padding: 2rem 1rem 1rem 1rem;
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .dark-toggle {
      position: absolute;
      top: 1.5rem;
      right: 2rem;
      background: var(--card);
      color: var(--primary);
      border: none;
      border-radius: 2rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: var(--shadow);
      transition: background var(--transition), color var(--transition);
    }
    .welcome {
      font-size: 2.2rem;
      font-weight: 700;
      margin: 0.5rem 0 0.2rem 0;
      letter-spacing: -1px;
    }
    .subtitle {
      font-size: 1.1rem;
      font-weight: 400;
      margin-bottom: 0.5rem;
      opacity: 0.85;
    }
    main {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2rem;
      padding: 2rem 2vw;
      max-width: 1400px;
      margin: 0 auto;
    }
    section {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem 1.2rem;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      transition: background var(--transition), color var(--transition);
    }
    section h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
      color: var(--primary);
      letter-spacing: 0.5px;
    }
    .dashboard-metrics {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .metric {
      background: var(--secondary);
      border-radius: 0.7rem;
      padding: 1rem 1.2rem;
      min-width: 110px;
      text-align: center;
      box-shadow: var(--shadow);
      flex: 1 1 120px;
    }
    .metric .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    .metric .label {
      font-size: 0.95rem;
      color: var(--text);
      opacity: 0.7;
    }
    .announcements {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .announcements li {
      margin-bottom: 0.7rem;
      padding-left: 1.2rem;
      position: relative;
    }
    .announcements li:before {
      content: "•";
      color: var(--accent);
      position: absolute;
      left: 0;
      font-size: 1.2rem;
      top: 0;
    }
    .team-spotlight {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .employee-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--secondary);
      border-radius: 0.7rem;
      padding: 0.7rem 1rem;
      box-shadow: var(--shadow);
    }
    .employee-card img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
    }
    .employee-info {
      flex: 1;
    }
    .employee-info .name {
      font-weight: 600;
      color: var(--primary);
    }
    .employee-info .role {
      font-size: 0.95rem;
      color: var(--text);
      opacity: 0.7;
    }
    .calendar {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .event {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      background: var(--secondary);
      border-radius: 0.5rem;
      padding: 0.5rem 0.8rem;
      font-size: 0.98rem;
      box-shadow: var(--shadow);
    }
    .event .date {
      font-weight: 700;
      color: var(--primary);
      min-width: 60px;
    }
    .resources {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .resource-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      background: var(--secondary);
      border-radius: 0.5rem;
      padding: 0.5rem 0.8rem;
      transition: background var(--transition);
    }
    .resource-link:hover {
      background: var(--accent);
      color: #fff;
    }
    .comm-hub {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .comm-update {
      background: var(--secondary);
      border-radius: 0.5rem;
      padding: 0.6rem 0.8rem;
      font-size: 0.98rem;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 0.7rem;
    }
    .comm-update .icon {
      color: var(--accent);
      font-size: 1.2rem;
    }
    .directory {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .directory-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--secondary);
      border-radius: 0.7rem;
      padding: 0.7rem 1rem;
      box-shadow: var(--shadow);
    }
    .directory-card img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
    }
    .directory-info {
      flex: 1;
    }
    .directory-info .name {
      font-weight: 600;
      color: var(--primary);
    }
    .directory-info .role {
      font-size: 0.95rem;
      color: var(--text);
      opacity: 0.7;
    }
    .directory-info .contact {
      font-size: 0.92rem;
      color: var(--text);
      opacity: 0.6;
    }
    .weather {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--secondary);
      border-radius: 0.7rem;
      padding: 0.7rem 1rem;
      box-shadow: var(--shadow);
      font-size: 1rem;
    }
    .weather .icon {
      font-size: 2rem;
    }
    .progress-bar {
      width: 100%;
      background: #e0e7ef;
      border-radius: 0.5rem;
      overflow: hidden;
      height: 1.1rem;
      margin-top: 0.3rem;
    }
    .progress {
      height: 100%;
      background: var(--primary);
      transition: width 0.7s cubic-bezier(.4,0,.2,1);
    }
    @media (max-width: 700px) {
      main {
        grid-template-columns: 1fr;
        padding: 1rem 0.5rem;
        gap: 1.2rem;
      }
      header {
        padding: 1.2rem 0.5rem 0.7rem 0.5rem;
      }
    }
    /* Focus styles for accessibility */
    a:focus, button:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    
    /* Loading animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .loading {
      animation: pulse 1.5s infinite;
    }
    
    .slide-in {
      animation: slideIn 0.5s ease-out;
    }
    
    /* Notification system */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--primary);
      color: #fff;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease-out;
      max-width: 300px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: #22c55e;
    }
    
    .notification.warning {
      background: var(--accent);
      color: #000;
    }
    
    /* Enhanced search */
    .search-container {
      position: relative;
      margin-bottom: 1rem;
    }
    
    .search-input {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 2.5rem;
      border: 2px solid var(--secondary);
      border-radius: var(--radius);
      background: var(--card);
      color: var(--text);
      font-size: 1rem;
      transition: border-color var(--transition);
    }
    
    .search-input:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .search-icon {
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 1.2rem;
    }
    
    /* Chat widget */
    .chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .chat-toggle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease;
    }
    
    .chat-toggle:hover {
      transform: scale(1.1);
    }
    
    .chat-panel {
      position: absolute;
      bottom: 80px;
      right: 0;
      width: 300px;
      height: 400px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-panel.open {
      display: flex;
    }
    
    .chat-header {
      background: var(--primary);
      color: #fff;
      padding: 1rem;
      font-weight: 600;
    }
    
    .chat-messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .chat-message {
      background: var(--secondary);
      padding: 0.5rem 0.8rem;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      max-width: 80%;
    }
    
    .chat-message.user {
      background: var(--primary);
      color: #fff;
      align-self: flex-end;
    }
    
    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid var(--secondary);
    }
    
    .chat-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--secondary);
      border-radius: 0.5rem;
      background: var(--bg);
      color: var(--text);
    }
    
    /* Quick actions */
    .quick-actions {
      position: fixed;
      bottom: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 999;
    }
    
    .quick-action {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--card);
      color: var(--primary);
      border: 2px solid var(--primary);
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
    }
    
    .quick-action:hover {
      background: var(--primary);
      color: #fff;
      transform: scale(1.1);
    }
    
    /* Enhanced metrics with charts */
    .metric-chart {
      width: 100%;
      height: 40px;
      background: var(--secondary);
      border-radius: 0.3rem;
      margin-top: 0.5rem;
      position: relative;
      overflow: hidden;
    }
    
    .metric-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transition: width 1s ease-out;
      border-radius: 0.3rem;
    }
    
    /* Activity feed */
    .activity-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--secondary);
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .activity-content {
      flex: 1;
      font-size: 0.9rem;
    }
    
    .activity-time {
      font-size: 0.8rem;
      color: var(--text);
      opacity: 0.6;
    }
    
    /* Enhanced hover effects */
    section:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .employee-card:hover, .directory-card:hover, .event:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    }
    
    /* Skeleton loading for better UX */
    .skeleton {
      background: linear-gradient(90deg, var(--secondary) 25%, transparent 37%, var(--secondary) 63%);
      background-size: 400% 100%;
      animation: skeleton-loading 1.4s ease-in-out infinite;
    }
    
    @keyframes skeleton-loading {
      0% { background-position: 100% 50%; }
      100% { background-position: 0 50%; }
    }
    
    /* Calendar Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .modal-overlay.show {
      display: flex;
    }
    
    .modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 2rem;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    
    .calendar-modal {
      width: 1000px;
      max-width: 95vw;
      padding: 1.5rem;
    }
    
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text);
      padding: 0.5rem;
      border-radius: 50%;
      transition: background var(--transition);
    }
    
    .modal-close:hover {
      background: var(--secondary);
    }
    
    /* Enhanced Calendar Styles */
    .calendar-header-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--secondary);
      border-radius: var(--radius);
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .calendar-nav button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background var(--transition);
    }
    
    .calendar-nav button:hover {
      background: var(--accent);
      color: #000;
    }
    
    .calendar-month-year {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .calendar-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-add-event {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 0.7rem 1.2rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
    }
    
    .btn-add-event:hover {
      background: var(--primary);
      color: #fff;
      transform: translateY(-1px);
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--secondary);
      border-radius: 0.5rem;
      overflow: hidden;
    }
    
    .calendar-header {
      background: var(--primary);
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .calendar-day {
      background: var(--card);
      padding: 0.5rem;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.9rem;
      position: relative;
      cursor: pointer;
      transition: background var(--transition);
    }
    
    .calendar-day:hover {
      background: var(--secondary);
    }
    
    .calendar-day.other-month {
      opacity: 0.5;
      background: #f8f9fa;
    }
    
    .calendar-day.today {
      background: var(--primary);
      color: #fff;
    }
    
    .calendar-day.selected {
      background: var(--accent);
      color: #000;
    }
    
    .calendar-day-number {
      font-weight: 600;
      margin-bottom: 0.3rem;
    }
    
    .calendar-event {
      background: var(--primary);
      color: #fff;
      padding: 0.2rem 0.4rem;
      border-radius: 0.3rem;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 0.1rem;
      position: relative;
      transition: all var(--transition);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .calendar-event:hover {
      background: var(--accent);
      color: #000;
      transform: scale(1.02);
    }
    
    .calendar-event.high-priority {
      background: #ef4444;
    }
    
    .calendar-event.medium-priority {
      background: #f59e0b;
    }
    
    .calendar-event.low-priority {
      background: #10b981;
    }
    
    .calendar-event-delete {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(255, 255, 255, 0.8);
      color: #000;
      border: none;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 10px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .calendar-event:hover .calendar-event-delete {
      display: flex;
    }
    
    /* Event Form Modal */
    .event-form-modal {
      width: 500px;
    }
    
    .event-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .form-group label {
      font-weight: 600;
      color: var(--primary);
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      padding: 0.8rem;
      border: 2px solid var(--secondary);
      border-radius: 0.5rem;
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color var(--transition);
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--secondary);
    }
    
    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background var(--transition);
    }
    
    .btn-primary:hover {
      background: var(--accent);
      color: #000;
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: var(--text);
      border: 2px solid var(--secondary);
      padding: 0.8rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all var(--transition);
    }
    
    .btn-secondary:hover {
      background: var(--bg);
      border-color: var(--primary);
    }
    
    .btn-danger {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background var(--transition);
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    /* Event Details Modal */
    .event-details {
      padding: 1rem 0;
    }
    
    .event-detail-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--secondary);
    }
    
    .event-detail-item:last-child {
      border-bottom: none;
    }
    
    .event-detail-icon {
      color: var(--primary);
      font-size: 1.1rem;
      width: 20px;
    }
    
    .event-detail-content {
      flex: 1;
    }
    
    .event-detail-label {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
    }
    
    .event-detail-value {
      color: var(--text);
      margin-top: 0.2rem;
    }
    
    /* Message Composer */
    .message-modal {
      width: 500px;
    }
    
    .message-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .message-form input,
    .message-form textarea {
      padding: 0.8rem;
      border: 2px solid var(--secondary);
      border-radius: 0.5rem;
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
    }
    
    .message-form textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    .message-form button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background var(--transition);
    }
    
    .message-form button:hover {
      background: var(--accent);
      color: #000;
    }
    
    /* Enhanced Real Weather Widget */
    .weather {
      position: relative;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .weather:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    
    .weather::after {
      content: 'Click for details';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--primary);
      color: white;
      font-size: 0.8rem;
      text-align: center;
      padding: 0.3rem;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    
    .weather:hover::after {
      transform: translateY(0);
    }
    
    .weather-details {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .weather-main {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .weather-main .icon {
      font-size: 2.5rem;
      animation: weather-icon-float 3s ease-in-out infinite;
    }
    
    @keyframes weather-icon-float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    .weather-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    .weather-info span {
      background: var(--bg);
      padding: 0.3rem 0.6rem;
      border-radius: 0.3rem;
      transition: background 0.3s ease, transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .weather-info span:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.05);
    }
    
    .weather-temp {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    /* Weather loading animation */
    @keyframes weather-loading {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .weather-loading .icon {
      animation: weather-loading 2s linear infinite;
    }

    /* Device Management Styles */
    .devices-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .btn-add-device {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-add-device:hover {
      background: var(--accent);
      color: #000;
      transform: translateY(-2px);
    }

    .devices-stats {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .devices-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .device-card {
      background: var(--card-bg);
      border: 2px solid var(--secondary);
      border-radius: 0.8rem;
      padding: 1.2rem;
      transition: all var(--transition);
      position: relative;
    }

    .device-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .device-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .device-info {
      flex: 1;
    }

    .device-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.3rem;
    }

    .device-type {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .device-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-online {
      background: #10b981;
    }

    .status-offline {
      background: #ef4444;
    }

    .status-unknown {
      background: #f59e0b;
    }

    .device-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .device-detail {
      display: flex;
      flex-direction: column;
    }

    .device-detail-label {
      font-weight: 500;
      color: var(--primary);
      margin-bottom: 0.2rem;
    }

    .device-detail-value {
      color: var(--text);
    }

    .device-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .device-action-btn {
      background: var(--secondary);
      border: none;
      padding: 0.5rem 0.8rem;
      border-radius: 0.4rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all var(--transition);
      color: var(--text);
    }

    .device-action-btn:hover {
      background: var(--primary);
      color: #fff;
    }

    .device-action-btn.danger {
      background: #ef4444;
      color: #fff;
    }

    .device-action-btn.danger:hover {
      background: #dc2626;
    }

    .device-type-icon {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .device-modal {
      width: 500px;
      max-width: 90vw;
    }

    .device-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .device-form small {
      color: var(--text-secondary);
      font-size: 0.8rem;
      margin-top: 0.3rem;
    }

    .empty-devices {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-devices-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .devices-filter {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: var(--secondary);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.4rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all var(--transition);
      color: var(--text);
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: var(--primary);
      color: #fff;
    }

    /* Device type icons */
    .device-card[data-type="laptop"] .device-type-icon::before { content: "💻"; }
    .device-card[data-type="desktop"] .device-type-icon::before { content: "🖥️"; }
    .device-card[data-type="mobile"] .device-type-icon::before { content: "📱"; }
    .device-card[data-type="tablet"] .device-type-icon::before { content: "📱"; }
    .device-card[data-type="printer"] .device-type-icon::before { content: "🖨️"; }
    .device-card[data-type="server"] .device-type-icon::before { content: "🖥️"; }
    .device-card[data-type="router"] .device-type-icon::before { content: "📶"; }
    .device-card[data-type="camera"] .device-type-icon::before { content: "📷"; }
    .device-card[data-type="other"] .device-type-icon::before { content: "⚙️"; }
  </style>
</head>
<body>
  <header>
    <button class="dark-toggle" aria-label="Toggle dark mode" tabindex="0">🌙 Dark Mode</button>
    <div class="welcome" id="welcome">Welcome, Alex!</div>
    <div class="subtitle">Axero - Empowering Collaboration</div>
    
    <!-- Global Search -->
    <div class="search-container">
      <div class="search-icon">🔍</div>
      <input type="text" class="search-input" placeholder="Search people, projects, documents..." id="global-search" />
    </div>
  </header>
  <main>
    <section aria-labelledby="notice-board-title" style="grid-column: 1 / -1;">
      <h2 id="notice-board-title">Notice Board</h2>
      <div style="background: var(--secondary); padding: 1rem; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h3 style="margin: 0; color: var(--primary);">Important Announcements</h3>
          <p style="margin: 0.5rem 0 0 0;">Click on any announcement for more details</p>
        </div>
        <button class="btn-primary" onclick="openAddAnnouncementModal()" style="display: flex; align-items: center; gap: 0.5rem;">
          <span>+</span> Add Announcement
        </button>
      </div>
      <div id="notice-board" style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
        <!-- Notice board items will be injected here -->
      </div>
    </section>
    
    <section aria-labelledby="dashboard-title">
      <h2 id="dashboard-title">Company Dashboard</h2>
      <div class="dashboard-metrics">
        <div class="metric">
          <div class="value" id="active-users">--</div>
          <div class="label">Active Users</div>
          <div class="metric-chart">
            <div class="metric-bar" id="users-bar" style="width: 0%"></div>
          </div>
        </div>
        <div class="metric">
          <div class="value" id="projects">--</div>
          <div class="label">Projects</div>
          <div class="metric-chart">
            <div class="metric-bar" id="projects-bar" style="width: 0%"></div>
          </div>
        </div>
        <div class="metric">
          <div class="value" id="satisfaction">--</div>
          <div class="label">Satisfaction</div>
          <div class="metric-chart">
            <div class="metric-bar" id="satisfaction-bar" style="width: 0%"></div>
          </div>
        </div>
        <div class="metric">
          <div class="value" id="dashboard-devices">--</div>
          <div class="label">Online Devices</div>
          <div class="metric-chart">
            <div class="metric-bar" id="devices-bar" style="width: 0%"></div>
          </div>
        </div>
      </div>
      <ul class="announcements" id="announcements">
        <!-- Announcements will be injected here -->
      </ul>
    </section>
    <section aria-labelledby="spotlight-title">
      <h2 id="spotlight-title">Team Spotlights</h2>
      <div class="team-spotlight" id="spotlights">
        <!-- Team spotlights will be injected here -->
      </div>
    </section>
    <section aria-labelledby="calendar-title">
      <h2 id="calendar-title">Upcoming Events</h2>
      <div class="calendar" id="calendar">
        <!-- Events will be injected here -->
      </div>
    </section>
    <section aria-labelledby="resources-title">
      <h2 id="resources-title">Useful Resources</h2>
      <div class="resources" id="resources">
        <!-- Resources will be injected here -->
      </div>
    </section>
    <section aria-labelledby="comm-title">
      <h2 id="comm-title">Communication Hub</h2>
      <div class="comm-hub" id="comm-hub">
        <!-- Communication updates will be injected here -->
      </div>
    </section>
    <section aria-labelledby="directory-title">
      <h2 id="directory-title">Employee Directory</h2>
      <div class="directory" id="directory">
        <!-- Directory will be injected here -->
      </div>
    </section>
    <section aria-labelledby="weather-title">
      <h2 id="weather-title">Weather - Loading location...</h2>
      <div class="weather" id="weather">
        <div class="weather-details">
          <div class="weather-main">
            <span class="icon" id="weather-icon">🔄</span>
            <div>
              <div id="weather-desc">Detecting your location...</div>
              <div id="weather-temp" class="weather-temp"></div>
            </div>
          </div>
          <div class="weather-info" id="weather-info">
            <span>Please wait while we get the weather for your location</span>
          </div>
        </div>
      </div>
    </section>
    <section aria-labelledby="recognition-title">
      <h2 id="recognition-title">Employee Recognition</h2>
      <div class="team-spotlight" id="recognition">
        <!-- Recognition board will be injected here -->
      </div>
    </section>
    <section aria-labelledby="project-title">
      <h2 id="project-title">Project Status</h2>
      <div id="project-status">
        <!-- Project status bars will be injected here -->
      </div>
    </section>
    
    <!-- New Activity Feed Section -->
    <section aria-labelledby="activity-title">
      <h2 id="activity-title">Recent Activity</h2>
      <div id="activity-feed">
        <!-- Activity feed will be injected here -->
      </div>
    </section>
    
    <!-- Device Management Section -->
    <section aria-labelledby="devices-title">
      <h2 id="devices-title">Network Devices</h2>
      <div class="devices-controls">
        <button class="btn-add-device" onclick="openAddDeviceModal()">+ Add Device</button>
        <div class="devices-stats">
          <span id="total-devices">--</span> devices connected
        </div>
      </div>
      <div id="devices-list" class="devices-container">
        <!-- Devices will be injected here -->
      </div>
    </section>
  </main>
  
  <!-- Notification System -->
  <div id="notification" class="notification"></div>
  
  <!-- Quick Actions -->
  <div class="quick-actions">
    <button class="quick-action" title="New Message" onclick="openMessageComposer()">💬</button>
    <button class="quick-action" title="Calendar" onclick="openCalendar()">📅</button>
    <button class="quick-action" title="Device Management" onclick="openAddDeviceModal()">📱</button>
    <button class="quick-action" title="Screenshot" onclick="startScreenshot()">📸</button>
    <button class="quick-action" title="Help" onclick="openHelp()">❓</button>
  </div>
  
  <!-- Screenshot Tool -->
  <div id="screenshot-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; cursor: crosshair;">
    <div id="screenshot-selection" style="position: absolute; border: 2px dashed white; background: rgba(45, 108, 223, 0.2); display: none;"></div>
    <div id="screenshot-instructions" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold;">
      Click and drag to select an area to capture
    </div>
  </div>
  
  <!-- Chat Widget -->
  <div class="chat-widget">
    <button class="chat-toggle" onclick="toggleChat()">💬</button>
    <div class="chat-panel" id="chat-panel">
      <div class="chat-header">
        Team Chat
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="chat-message">Hi! How can I help you today?</div>
      </div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" placeholder="Type a message..." onkeypress="handleChatInput(event)" />
      </div>
    </div>
  </div>
  
  <!-- Calendar Modal -->
  <div class="modal-overlay" id="calendar-modal">
    <div class="modal calendar-modal">
      <button class="modal-close" onclick="closeModal('calendar-modal')">&times;</button>
      
      <!-- Calendar Header Controls -->
      <div class="calendar-header-controls">
        <div class="calendar-nav">
          <button onclick="changeMonth(-1)">❮ Prev</button>
          <div class="calendar-month-year" id="calendar-month-year">July 2025</div>
          <button onclick="changeMonth(1)">Next ❯</button>
        </div>
        <div class="calendar-actions">
          <button class="btn-add-event" onclick="openAddEventModal()">+ Add Event</button>
        </div>
      </div>
      
      <!-- Calendar Grid -->
      <div class="calendar-grid" id="calendar-grid">
        <!-- Calendar will be generated here -->
      </div>
    </div>
  </div>
  
  <!-- Add/Edit Event Modal -->
  <div class="modal-overlay" id="event-modal">
    <div class="modal event-form-modal">
      <button class="modal-close" onclick="closeModal('event-modal')">&times;</button>
      <h2 id="event-modal-title">Add New Event</h2>
      
      <form class="event-form" onsubmit="saveEvent(event)">
        <div class="form-group">
          <label for="event-title">Event Title</label>
          <input type="text" id="event-title" placeholder="Enter event title" required />
        </div>
        
        <div class="form-group">
          <label for="event-description">Description</label>
          <textarea id="event-description" placeholder="Event description (optional)"></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="event-date">Date</label>
            <input type="date" id="event-date" required />
          </div>
          <div class="form-group">
            <label for="event-priority">Priority</label>
            <select id="event-priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="event-start-time">Start Time</label>
            <input type="time" id="event-start-time" value="09:00" />
          </div>
          <div class="form-group">
            <label for="event-end-time">End Time</label>
            <input type="time" id="event-end-time" value="10:00" />
          </div>
        </div>
        
        <div class="form-group">
          <label for="event-location">Location</label>
          <input type="text" id="event-location" placeholder="Meeting room, video call, etc." />
        </div>
        
        <div class="form-group">
          <label for="event-attendees">Attendees</label>
          <input type="text" id="event-attendees" placeholder="Email addresses separated by commas" />
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeModal('event-modal')">Cancel</button>
          <button type="button" class="btn-danger" id="delete-event-btn" onclick="deleteCurrentEvent()" style="display: none;">Delete</button>
          <button type="submit" class="btn-primary" id="save-event-btn">Save Event</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Event Details Modal -->
  <div class="modal-overlay" id="event-details-modal">
    <div class="modal event-form-modal">
      <button class="modal-close" onclick="closeModal('event-details-modal')">&times;</button>
      <h2 id="event-details-title">Event Details</h2>
      
      <div class="event-details" id="event-details-content">
        <!-- Event details will be populated here -->
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="closeModal('event-details-modal')">Close</button>
        <button type="button" class="btn-primary" onclick="editCurrentEvent()">Edit Event</button>
        <button type="button" class="btn-danger" onclick="deleteCurrentEvent()">Delete Event</button>
      </div>
    </div>
  </div>
  
  <!-- Message Composer Modal -->
  <div class="modal-overlay" id="message-modal">
    <div class="modal message-modal">
      <button class="modal-close" onclick="closeModal('message-modal')">&times;</button>
      <h2>Send Message</h2>
      <form class="message-form" onsubmit="sendMessage(event)">
        <input type="text" id="message-to" placeholder="To: (email or name)" required />
        <input type="text" id="message-subject" placeholder="Subject" required />
        <textarea id="message-body" placeholder="Your message..." required></textarea>
        <button type="submit">Send Message</button>
      </form>
    </div>
  </div>
  
  <!-- Help Modal -->
  <div class="modal-overlay" id="help-modal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('help-modal')">&times;</button>
      <h2>Help & Support</h2>
      <div id="help-content">
        <h3>Quick Actions:</h3>
        <ul>
          <li><strong>Ctrl+K</strong> - Open global search</li>
          <li><strong>Ctrl+D</strong> - Toggle dark/light mode</li>
          <li><strong>Ctrl+E</strong> - Add new device</li>
          <li><strong>Ctrl+N</strong> - Quick add (device/event)</li>
          <li>Click any team member for contact info</li>
          <li>Use the chat widget for instant messaging</li>
        </ul>
        <h3>Common Tasks:</h3>
        <ul>
          <li>Submit IT tickets via IT Helpdesk link</li>
          <li>View company announcements in the dashboard</li>
          <li>Check upcoming events in the calendar</li>
          <li>Access HR Portal for benefits and policies</li>
        </ul>
        <h3>Need More Help?</h3>
        <p>Contact IT Support: <strong>it-support@axero.com</strong></p>
        <p>HR Questions: <strong>hr@axero.com</strong></p>
      </div>
    </div>
  </div>

  <!-- Device Management Modal -->
  <div class="modal-overlay" id="device-modal">
    <div class="modal device-modal">
      <button class="modal-close" onclick="closeModal('device-modal')">&times;</button>
      <h2 id="device-modal-title">Add Device</h2>
      
      <form class="device-form" onsubmit="handleDeviceSubmit(event)">
        <div class="form-group">
          <label for="device-name">Device Name</label>
          <input type="text" id="device-name" name="name" placeholder="My Laptop" required />
        </div>
        
        <div class="form-group">
          <label for="device-type">Device Type</label>
          <select id="device-type" name="type" required>
            <option value="">Select type...</option>
            <option value="laptop">Laptop</option>
            <option value="desktop">Desktop</option>
            <option value="mobile">Mobile Phone</option>
            <option value="tablet">Tablet</option>
            <option value="printer">Printer</option>
            <option value="server">Server</option>
            <option value="router">Router/Switch</option>
            <option value="camera">Security Camera</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="device-ip">IP Address</label>
          <input type="text" id="device-ip" name="ip" placeholder="192.168.1.100" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" />
          <small>Optional - leave blank for auto-assignment</small>
        </div>
        
        <div class="form-group">
          <label for="device-mac">MAC Address</label>
          <input type="text" id="device-mac" name="mac" placeholder="AA:BB:CC:DD:EE:FF" pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$" />
          <small>Optional - for network identification</small>
        </div>
        
        <div class="form-group">
          <label for="device-location">Location</label>
          <input type="text" id="device-location" name="location" placeholder="Office 2A, Desk 15" />
        </div>
        
        <div class="form-group">
          <label for="device-owner">Owner/User</label>
          <input type="text" id="device-owner" name="owner" placeholder="John Doe" />
        </div>
        
        <div class="form-group">
          <label for="device-description">Description</label>
          <textarea id="device-description" name="description" placeholder="Additional notes about this device..." rows="3"></textarea>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeModal('device-modal')">Cancel</button>
          <button type="submit" class="btn-primary" id="device-submit-btn">Add Device</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Database Configuration and Setup
    const DB_NAME = 'AxeroIntranetDB';
    const DB_VERSION = 1;
    let db = null;

    // Database Schema
    const STORES = {
      devices: 'devices',
      events: 'events', 
      activities: 'activities',
      chatMessages: 'chatMessages',
      employees: 'employees'
    };

    // Initialize IndexedDB
    async function initDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          console.log('✅ Database initialized successfully');
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // Devices store
          if (!db.objectStoreNames.contains(STORES.devices)) {
            const deviceStore = db.createObjectStore(STORES.devices, { keyPath: 'id' });
            deviceStore.createIndex('type', 'type', { unique: false });
            deviceStore.createIndex('status', 'status', { unique: false });
            deviceStore.createIndex('owner', 'owner', { unique: false });
          }
          
          // Events store
          if (!db.objectStoreNames.contains(STORES.events)) {
            const eventStore = db.createObjectStore(STORES.events, { keyPath: 'id' });
            eventStore.createIndex('date', 'date', { unique: false });
            eventStore.createIndex('priority', 'priority', { unique: false });
          }
          
          // Activities store
          if (!db.objectStoreNames.contains(STORES.activities)) {
            const activityStore = db.createObjectStore(STORES.activities, { keyPath: 'id', autoIncrement: true });
            activityStore.createIndex('timestamp', 'timestamp', { unique: false });
            activityStore.createIndex('type', 'type', { unique: false });
          }
          
          // Chat Messages store
          if (!db.objectStoreNames.contains(STORES.chatMessages)) {
            const chatStore = db.createObjectStore(STORES.chatMessages, { keyPath: 'id', autoIncrement: true });
            chatStore.createIndex('timestamp', 'timestamp', { unique: false });
          }
          
          // Employees store
          if (!db.objectStoreNames.contains(STORES.employees)) {
            const employeeStore = db.createObjectStore(STORES.employees, { keyPath: 'id' });
            employeeStore.createIndex('department', 'department', { unique: false });
            employeeStore.createIndex('role', 'role', { unique: false });
          }
          
          console.log('📊 Database schema created');
        };
      });
    }

    // Database Helper Functions
    async function dbOperation(storeName, operation, data = null, key = null) {
      if (!db) {
        throw new Error('Database not initialized');
      }
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], operation === 'get' || operation === 'getAll' || operation === 'count' ? 'readonly' : 'readwrite');
        const store = transaction.objectStore(storeName);
        let request;
        
        switch (operation) {
          case 'add':
            request = store.add(data);
            break;
          case 'put':
            request = store.put(data);
            break;
          case 'delete':
            request = store.delete(key);
            break;
          case 'get':
            request = store.get(key);
            break;
          case 'getAll':
            request = store.getAll();
            break;
          case 'count':
            request = store.count();
            break;
          default:
            reject(new Error(`Unknown operation: ${operation}`));
            return;
        }
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // Database API Functions
    const DatabaseAPI = {
      // Devices
      async addDevice(device) {
        device.id = device.id || Date.now().toString();
        device.createdAt = new Date().toISOString();
        device.updatedAt = new Date().toISOString();
        return await dbOperation(STORES.devices, 'add', device);
      },
      
      async updateDevice(device) {
        device.updatedAt = new Date().toISOString();
        return await dbOperation(STORES.devices, 'put', device);
      },
      
      async deleteDevice(deviceId) {
        return await dbOperation(STORES.devices, 'delete', null, deviceId);
      },
      
      async getDevice(deviceId) {
        return await dbOperation(STORES.devices, 'get', null, deviceId);
      },
      
      async getAllDevices() {
        return await dbOperation(STORES.devices, 'getAll');
      },
      
      async getDevicesByType(type) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORES.devices], 'readonly');
          const store = transaction.objectStore(STORES.devices);
          const index = store.index('type');
          const request = index.getAll(type);
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      },
      
      // Events
      async addEvent(event) {
        event.id = event.id || Date.now().toString();
        event.createdAt = new Date().toISOString();
        return await dbOperation(STORES.events, 'add', event);
      },
      
      async updateEvent(event) {
        event.updatedAt = new Date().toISOString();
        return await dbOperation(STORES.events, 'put', event);
      },
      
      async deleteEvent(eventId) {
        return await dbOperation(STORES.events, 'delete', null, eventId);
      },
      
      async getAllEvents() {
        return await dbOperation(STORES.events, 'getAll');
      },
      
      // Activities
      async addActivity(activity) {
        activity.timestamp = activity.timestamp || new Date().toISOString();
        activity.id = Date.now() + Math.random(); // Ensure uniqueness
        return await dbOperation(STORES.activities, 'add', activity);
      },
      
      async getRecentActivities(limit = 20) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORES.activities], 'readonly');
          const store = transaction.objectStore(STORES.activities);
          const index = store.index('timestamp');
          const request = index.openCursor(null, 'prev'); // Newest first
          
          const results = [];
          request.onsuccess = (event) => {
            const cursor = event.target.result;
            if (cursor && results.length < limit) {
              results.push(cursor.value);
              cursor.continue();
            } else {
              resolve(results);
            }
          };
          request.onerror = () => reject(request.error);
        });
      },
      
      // Chat Messages
      async addChatMessage(message) {
        message.timestamp = message.timestamp || new Date().toISOString();
        return await dbOperation(STORES.chatMessages, 'add', message);
      },
      
      async getChatMessages(limit = 50) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORES.chatMessages], 'readonly');
          const store = transaction.objectStore(STORES.chatMessages);
          const index = store.index('timestamp');
          const request = index.getAll();
          
          request.onsuccess = () => {
            const messages = request.result.slice(-limit); // Get last N messages
            resolve(messages);
          };
          request.onerror = () => reject(request.error);
        });
      }
    };

    // Authentication and User Management
    let currentUser = null;
    
    // Check authentication status
    function checkAuthentication() {
      // Try to get auth data from storage
      const auth = JSON.parse(localStorage.getItem('axero_auth') || sessionStorage.getItem('axero_auth') || '{}');
      
      if (!auth.token || !auth.user || auth.expires <= new Date().getTime()) {
        // Not authenticated or token expired, redirect to login
        window.location.href = 'login.html';
        return false;
      }
      
      // Set current user
      currentUser = auth.user;
      return true;
    }
    
    // Initialize user data
    function initializeUserData() {
      if (!currentUser) return;
      
      // Update welcome message
      document.getElementById('welcome').textContent = `Welcome, ${currentUser.name}!`;
      
      // Add user profile to header
      const header = document.querySelector('header');
      const userProfileHTML = `
        <div class="user-profile" onclick="toggleUserMenu()" style="position: absolute; top: 1.5rem; right: 8rem; display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
          <img src="${currentUser.avatar}" alt="${currentUser.name}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;" />
          <div style="color: white;">
            <div style="font-weight: 600;">${currentUser.name}</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">${currentUser.role}</div>
          </div>
          <div class="user-menu" id="user-menu" style="position: absolute; top: 100%; right: 0; background: var(--bg); border-radius: var(--radius); box-shadow: var(--shadow); width: 200px; display: none; z-index: 1000;">
            <div style="padding: 1rem; border-bottom: 1px solid var(--secondary);">
              <div style="font-weight: 600;">${currentUser.name}</div>
              <div style="font-size: 0.8rem; opacity: 0.8;">${currentUser.email}</div>
            </div>
            <div style="display: flex; flex-direction: column;">
              <a href="javascript:openUserProfile()" style="padding: 0.8rem 1rem; text-decoration: none; color: var(--text); transition: background 0.2s ease;">My Profile</a>
              <a href="javascript:openUserSettings()" style="padding: 0.8rem 1rem; text-decoration: none; color: var(--text); transition: background 0.2s ease;">Settings</a>
              <a href="javascript:logout()" style="padding: 0.8rem 1rem; text-decoration: none; color: #ef4444; transition: background 0.2s ease;">Logout</a>
            </div>
          </div>
        </div>
      `;
      header.insertAdjacentHTML('beforeend', userProfileHTML);
      
      // Add hover effect to user menu items
      document.querySelectorAll('#user-menu a').forEach(item => {
        item.addEventListener('mouseover', function() {
          this.style.background = 'var(--secondary)';
        });
        
        item.addEventListener('mouseout', function() {
          this.style.background = 'transparent';
        });
      });
      
      // Add click outside to close user menu
      document.addEventListener('click', function(e) {
        const userMenu = document.getElementById('user-menu');
        const userProfile = document.querySelector('.user-profile');
        
        if (userMenu.style.display === 'block' && !userProfile.contains(e.target)) {
          userMenu.style.display = 'none';
        }
      });
      
      // Add to activity feed
      addToActivityFeed(`${currentUser.name} logged in`, 'login');
    }
    
    // Toggle user menu
    function toggleUserMenu() {
      const userMenu = document.getElementById('user-menu');
      userMenu.style.display = userMenu.style.display === 'block' ? 'none' : 'block';
    }
    
    // Logout function
    function logout() {
      // Clear auth data
      localStorage.removeItem('axero_auth');
      sessionStorage.removeItem('axero_auth');
      
      // Redirect to login page
      window.location.href = 'login.html';
    }
    
    // Open user profile
    function openUserProfile() {
      // Create modal if it doesn't exist
      if (!document.getElementById('user-profile-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="user-profile-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('user-profile-modal')">&times;</button>
              <div style="display: flex; gap: 1.5rem; align-items: flex-start; margin-bottom: 1.5rem;">
                <img src="${currentUser.avatar}" alt="${currentUser.name}" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary);" />
                <div>
                  <h2 style="margin-top: 0; color: var(--primary);">${currentUser.name}</h2>
                  <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">${currentUser.role}</div>
                  <div style="color: var(--text); opacity: 0.8;">${currentUser.email}</div>
                </div>
              </div>
              
              <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn-primary" onclick="showProfileTab('info')" id="profile-tab-info">Account Info</button>
                <button class="btn-secondary" onclick="showProfileTab('devices')" id="profile-tab-devices">Logged In Devices</button>
              </div>
              
              <div id="profile-tab-content-info" style="display: block;">
                <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
                  <h3 style="margin-top: 0;">Account Information</h3>
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem;">
                    <div style="font-weight: 600;">Username:</div>
                    <div>${currentUser.username}</div>
                    <div style="font-weight: 600;">Email:</div>
                    <div>${currentUser.email}</div>
                    <div style="font-weight: 600;">Role:</div>
                    <div>${currentUser.role}</div>
                    <div style="font-weight: 600;">Last Login:</div>
                    <div>${new Date().toLocaleString()}</div>
                  </div>
                </div>
              </div>
              
              <div id="profile-tab-content-devices" style="display: none;">
                <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
                  <h3 style="margin-top: 0;">Logged In Devices</h3>
                  <div style="margin-bottom: 1rem;">
                    <div style="background: var(--bg); padding: 1rem; border-radius: var(--radius); margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-weight: 600;">Current Device</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">${navigator.userAgent}</div>
                        <div style="font-size: 0.8rem; color: var(--primary); margin-top: 0.3rem;">Last active: Just now</div>
                      </div>
                      <div>
                        <span style="background: #10b981; color: white; padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.8rem;">Current</span>
                      </div>
                    </div>
                    
                    <div style="background: var(--bg); padding: 1rem; border-radius: var(--radius); margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-weight: 600;">Mobile Device</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">iPhone - Safari</div>
                        <div style="font-size: 0.8rem; color: var(--primary); margin-top: 0.3rem;">Last active: 2 hours ago</div>
                      </div>
                      <div>
                        <button class="btn-danger" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Logout</button>
                      </div>
                    </div>
                    
                    <div style="background: var(--bg); padding: 1rem; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-weight: 600;">Home Computer</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Windows - Chrome</div>
                        <div style="font-size: 0.8rem; color: var(--primary); margin-top: 0.3rem;">Last active: Yesterday</div>
                      </div>
                      <div>
                        <button class="btn-danger" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Logout</button>
                      </div>
                    </div>
                  </div>
                  
                  <button class="btn-danger">Logout from all devices</button>
                </div>
              </div>
              
              <div class="form-actions">
                <button class="btn-secondary" onclick="closeModal('user-profile-modal')">Close</button>
                <button class="btn-primary" onclick="openUserSettings()">Edit Profile</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Show modal
      document.getElementById('user-profile-modal').classList.add('show');
      document.getElementById('user-menu').style.display = 'none';
    }
    
    // Show profile tab
    function showProfileTab(tab) {
      // Hide all tabs
      document.getElementById('profile-tab-content-info').style.display = 'none';
      document.getElementById('profile-tab-content-devices').style.display = 'none';
      
      // Show selected tab
      document.getElementById(`profile-tab-content-${tab}`).style.display = 'block';
      
      // Update tab buttons
      document.getElementById('profile-tab-info').className = tab === 'info' ? 'btn-primary' : 'btn-secondary';
      document.getElementById('profile-tab-devices').className = tab === 'devices' ? 'btn-primary' : 'btn-secondary';
    }
    
    // Open user settings
    function openUserSettings() {
      // Create modal if it doesn't exist
      if (!document.getElementById('user-settings-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="user-settings-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('user-settings-modal')">&times;</button>
              <h2>User Settings</h2>
              
              <div style="margin-bottom: 1.5rem;">
                <div class="form-group">
                  <label for="settings-name">Display Name</label>
                  <input type="text" id="settings-name" value="${currentUser.name}" />
                </div>
                
                <div class="form-group">
                  <label for="settings-email">Email</label>
                  <input type="email" id="settings-email" value="${currentUser.email}" />
                </div>
                
                <div class="form-group">
                  <label for="settings-password">New Password</label>
                  <input type="password" id="settings-password" placeholder="Leave blank to keep current password" />
                </div>
                
                <div class="form-group">
                  <label>Theme Preference</label>
                  <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="radio" name="theme" value="light" checked /> Light
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="radio" name="theme" value="dark" /> Dark
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="radio" name="theme" value="system" /> System Default
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="form-actions">
                <button class="btn-secondary" onclick="closeModal('user-settings-modal')">Cancel</button>
                <button class="btn-primary" onclick="saveUserSettings()">Save Changes</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Close other modals
      closeModal('user-profile-modal');
      document.getElementById('user-menu').style.display = 'none';
      
      // Show modal
      document.getElementById('user-settings-modal').classList.add('show');
    }
    
    // Save user settings
    function saveUserSettings() {
      const name = document.getElementById('settings-name').value;
      const email = document.getElementById('settings-email').value;
      const password = document.getElementById('settings-password').value;
      const theme = document.querySelector('input[name="theme"]:checked').value;
      
      // Update user data
      currentUser.name = name;
      currentUser.email = email;
      
      // Update auth storage
      const auth = JSON.parse(localStorage.getItem('axero_auth') || sessionStorage.getItem('axero_auth') || '{}');
      auth.user = currentUser;
      
      if (localStorage.getItem('axero_auth')) {
        localStorage.setItem('axero_auth', JSON.stringify(auth));
      } else {
        sessionStorage.setItem('axero_auth', JSON.stringify(auth));
      }
      
      // Apply theme preference
      if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.querySelector('.dark-toggle').textContent = '☀️ Light Mode';
      } else if (theme === 'light') {
        document.documentElement.removeAttribute('data-theme');
        document.querySelector('.dark-toggle').textContent = '🌙 Dark Mode';
      }
      
      // Update UI
      document.querySelector('.user-profile img').src = currentUser.avatar;
      document.querySelector('.user-profile div:first-of-type').textContent = currentUser.name;
      document.getElementById('welcome').textContent = `Welcome, ${currentUser.name}!`;
      
      // Close modal and show notification
      closeModal('user-settings-modal');
      showNotification('Settings updated successfully!', 'success');
      
      // Add to activity feed
      addToActivityFeed('Updated user settings', 'settings-update');
    }
    
    // Check authentication before proceeding
    if (checkAuthentication()) {
      initializeUserData();
    }

    // Device Management Variables - Now using database
    let devices = [];
    let currentDeviceFilter = 'all';
    let editingDeviceId = null;

    // Initialize sample data in database
    async function initializeSampleData() {
      try {
        // Check if devices already exist
        const existingDevices = await DatabaseAPI.getAllDevices();
        
        if (existingDevices.length === 0) {
          // Add sample devices
          const sampleDevices = [
            {
              id: '1',
              name: 'Alex MacBook Pro',
              type: 'laptop',
              ip: '192.168.1.15',
              mac: '00:1B:44:11:3A:B7',
              location: 'Office 2A, Desk 12',
              owner: 'Alex Johnson',
              status: 'online',
              lastSeen: new Date().toISOString(),
              description: 'Primary work laptop'
            },
            {
              id: '2',
              name: 'Conference Room Printer',
              type: 'printer',
              ip: '192.168.1.25',
              mac: '00:1B:44:11:3A:C8',
              location: 'Conference Room A',
              owner: 'IT Department',
              status: 'online',
              lastSeen: new Date(Date.now() - 300000).toISOString(),
              description: 'HP LaserJet Pro for presentations'
            },
            {
              id: '3',
              name: 'Server-01',
              type: 'server',
              ip: '192.168.1.10',
              mac: '00:1B:44:11:3A:D9',
              location: 'Server Room',
              owner: 'IT Department',
              status: 'online',
              lastSeen: new Date().toISOString(),
              description: 'Main application server'
            },
            {
              id: '4',
              name: 'Sarah iPhone',
              type: 'mobile',
              ip: '192.168.1.45',
              mac: '00:1B:44:11:3A:E1',
              location: 'Office 1B, Desk 8',
              owner: 'Sarah Wilson',
              status: 'offline',
              lastSeen: new Date(Date.now() - 3600000).toISOString(),
              description: 'Personal iPhone connected to guest network'
            }
          ];

          for (const device of sampleDevices) {
            await DatabaseAPI.addDevice(device);
          }
          
          console.log('✅ Sample devices added to database');
        }

        // Load sample events if they don't exist
        const existingEvents = await DatabaseAPI.getAllEvents();
        if (existingEvents.length === 0) {
          const sampleEvents = [
            {
              id: 1,
              title: 'Sprint Review',
              description: 'Product sprint review meeting',
              date: '2025-07-10',
              time: '14:00-15:00',
              priority: 'high',
              location: 'Conference Room A',
              attendees: 'team@axero.com'
            },
            {
              id: 2,
              title: 'Team Lunch',
              description: 'Monthly team lunch',
              date: '2025-07-10',
              time: '12:00-13:00',
              priority: 'low',
              location: 'Office Cafeteria',
              attendees: 'all@axero.com'
            },
            {
              id: 3,
              title: 'New Hire Orientation',
              description: 'Welcome new team members',
              date: '2025-07-12',
              time: '11:00-12:00',
              priority: 'medium',
              location: 'HR Conference Room',
              attendees: 'hr@axero.com'
            }
          ];

          for (const event of sampleEvents) {
            await DatabaseAPI.addEvent(event);
          }
          
          console.log('✅ Sample events added to database');
        }

        // Initialize activities
        await DatabaseAPI.addActivity({
          user: '🖥️',
          action: 'Database system initialized successfully',
          type: 'system',
          time: 'just now'
        });

      } catch (error) {
        console.error('❌ Error initializing sample data:', error);
      }
    }

    // Device status helper function - needed by updateMetrics
    function getDeviceStatus(device) {
      const lastSeen = new Date(device.lastSeen);
      const now = new Date();
      const diffMinutes = Math.floor((now - lastSeen) / (1000 * 60));
      
      if (diffMinutes < 5) return 'online';
      if (diffMinutes < 60) return 'unknown';
      return 'offline';
    }

    // Dashboard metrics with enhanced animations
    function updateMetrics() {
      const users = 128;
      const projectCount = 12;
      const satisfaction = 97;
      const onlineDevices = devices ? devices.filter(device => getDeviceStatus(device) === 'online').length : 0;
      const totalDevices = devices ? devices.length : 0;
      
      document.getElementById('active-users').textContent = users;
      document.getElementById('projects').textContent = projectCount;
      document.getElementById('satisfaction').textContent = satisfaction + '%';
      document.getElementById('dashboard-devices').textContent = onlineDevices;
      
      // Animate metric bars
      setTimeout(() => {
        document.getElementById('users-bar').style.width = (users / 150 * 100) + '%';
        document.getElementById('projects-bar').style.width = (projectCount / 20 * 100) + '%';
        document.getElementById('satisfaction-bar').style.width = satisfaction + '%';
        document.getElementById('devices-bar').style.width = totalDevices > 0 ? (onlineDevices / totalDevices * 100) + '%' : '0%';
      }, 500);
    }
    
    updateMetrics();

    // Real Weather Data using OpenWeatherMap API and Geolocation
    const OPENWEATHER_API_KEY = '53673e596e0aec82e3a6dbadce249c40'; // Replace with your actual API key
    let userLocation = { city: 'Nairobi', country: 'KE' };
    let userCoordinates = { lat: -1.286389, lon: 36.817223 }; // Default to Nairobi

    // Weather condition icon mapping
    const weatherIcons = {
      '01d': '☀️', // clear sky day
      '01n': '🌙', // clear sky night
      '02d': '⛅', // few clouds day
      '02n': '☁️', // few clouds night
      '03d': '☁️', // scattered clouds
      '03n': '☁️',
      '04d': '☁️', // broken clouds
      '04n': '☁️',
      '09d': '🌧️', // shower rain
      '09n': '🌧️',
      '10d': '🌦️', // rain day
      '10n': '🌧️', // rain night
      '11d': '⛈️', // thunderstorm
      '11n': '⛈️',
      '13d': '❄️', // snow
      '13n': '❄️',
      '50d': '🌫️', // mist
      '50n': '🌫️'
    };
    
    // Get user's location using Geolocation API
    function getUserLocation() {
      if (navigator.geolocation) {
        document.getElementById('weather-desc').textContent = 'Getting your location...';
        
        navigator.geolocation.getCurrentPosition(
          // Success callback
          (position) => {
            userCoordinates = {
              lat: position.coords.latitude,
              lon: position.coords.longitude
            };
            
            // Get city name from coordinates using reverse geocoding
            fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${userCoordinates.lat}&lon=${userCoordinates.lon}&limit=1&appid=${OPENWEATHER_API_KEY}`)
              .then(response => response.json())
              .then(data => {
                if (data && data.length > 0) {
                  userLocation = {
                    city: data[0].name,
                    country: data[0].country
                  };
                  
                  // Update weather title
                  document.getElementById('weather-title').textContent = `Weather - ${userLocation.city}`;
                }
                updateWeather();
              })
              .catch(error => {
                console.error('Error getting location name:', error);
                updateWeather();
              });
          },
          // Error callback
          (error) => {
            console.error('Geolocation error:', error);
            showNotification('Unable to get your location. Using default location.', 'warning');
            updateWeather();
          },
          // Options
          { timeout: 10000 }
        );
      } else {
        showNotification('Geolocation is not supported by your browser. Using default location.', 'warning');
        updateWeather();
      }
    }
    
    // Fetch weather data from OpenWeatherMap API
    function updateWeather() {
      // Show loading state
      document.getElementById('weather-desc').textContent = 'Loading weather data...';
      document.getElementById('weather-icon').textContent = '🔄';
      document.getElementById('weather').classList.add('weather-loading');
      
      // Use coordinates for more accurate weather data
      fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${userCoordinates.lat}&lon=${userCoordinates.lon}&units=metric&appid=${OPENWEATHER_API_KEY}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Weather API error: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // Update location if we have it from the API
          if (data.name) {
            userLocation.city = data.name;
            document.getElementById('weather-title').textContent = `Weather - ${userLocation.city}`;
          }
          
          // Extract weather data
          const weatherData = {
            temperature: Math.round(data.main.temp),
            condition: data.weather[0].main,
            description: data.weather[0].description,
            icon: data.weather[0].icon,
            humidity: data.main.humidity,
            windSpeed: Math.round(data.wind.speed * 3.6), // Convert m/s to km/h
            pressure: data.main.pressure,
            feelsLike: Math.round(data.main.feels_like)
          };
          
          // Update UI with weather data
          document.getElementById('weather-icon').textContent = weatherIcons[weatherData.icon] || '🌤️';
          document.getElementById('weather-desc').textContent = weatherData.description.charAt(0).toUpperCase() + weatherData.description.slice(1);
          document.getElementById('weather-temp').textContent = `${weatherData.temperature}°C`;
          
          document.getElementById('weather-info').innerHTML = `
            <span>🌡️ Feels like: ${weatherData.feelsLike}°C</span>
            <span>💧 Humidity: ${weatherData.humidity}%</span>
            <span>💨 Wind: ${weatherData.windSpeed} km/h</span>
            <span>🌡️ Pressure: ${weatherData.pressure} hPa</span>
          `;
          
          // Remove loading state
          document.getElementById('weather').classList.remove('weather-loading');
          
          // Add to activity feed
          addToActivityFeed(`Weather updated for ${userLocation.city}`, 'weather-update');
        })
        .catch(error => {
          console.error('Weather API error:', error);
          showNotification('Unable to fetch weather data. Using simulated data.', 'warning');
          
          // Fallback to simulated weather if API fails
          const fallbackWeather = {
            temperature: Math.round(18 + Math.random() * 8),
            condition: 'Cloudy',
            humidity: Math.round(40 + Math.random() * 40),
            windSpeed: Math.round(5 + Math.random() * 15),
            pressure: Math.round(1010 + Math.random() * 20),
            feelsLike: Math.round(16 + Math.random() * 8)
          };
          
          document.getElementById('weather-icon').textContent = '☁️';
          document.getElementById('weather-desc').textContent = fallbackWeather.condition;
          document.getElementById('weather-temp').textContent = `${fallbackWeather.temperature}°C`;
          
          document.getElementById('weather-info').innerHTML = `
            <span>🌡️ Feels like: ${fallbackWeather.feelsLike}°C</span>
            <span>💧 Humidity: ${fallbackWeather.humidity}%</span>
            <span>💨 Wind: ${fallbackWeather.windSpeed} km/h</span>
            <span>🌡️ Pressure: ${fallbackWeather.pressure} hPa</span>
          `;
          
          // Remove loading state
          document.getElementById('weather').classList.remove('weather-loading');
        });
    }
    
    // Initialize weather with user's location
    getUserLocation();
    
    // Add refresh button and make weather widget clickable
    document.querySelector('.weather').insertAdjacentHTML('beforeend', `
      <button onclick="getUserLocation(); event.stopPropagation();" style="background: var(--primary); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: auto;" title="Refresh weather data">
        🔄
      </button>
    `);
    
    // Make weather widget clickable to show detailed weather
    document.querySelector('.weather').style.cursor = 'pointer';
    document.querySelector('.weather').addEventListener('click', showDetailedWeather);
    
    // Function to show detailed weather information
    function showDetailedWeather() {
      // Create modal if it doesn't exist
      if (!document.getElementById('weather-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="weather-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('weather-modal')">&times;</button>
              <h2>Weather Forecast for <span id="weather-modal-location">${userLocation.city}</span></h2>
              <div id="weather-modal-content">
                <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
                  <div style="font-size: 4rem;" id="weather-modal-icon">${document.getElementById('weather-icon').textContent}</div>
                  <div>
                    <div style="font-size: 2.5rem; font-weight: 600;" id="weather-modal-temp">${document.getElementById('weather-temp').textContent}</div>
                    <div style="font-size: 1.2rem;" id="weather-modal-desc">${document.getElementById('weather-desc').textContent}</div>
                  </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                  <div style="background: var(--secondary); padding: 1rem; border-radius: var(--radius);">
                    <h3 style="margin-top: 0;">Current Conditions</h3>
                    <div id="weather-modal-details">
                      Loading details...
                    </div>
                  </div>
                  <div style="background: var(--secondary); padding: 1rem; border-radius: var(--radius);">
                    <h3 style="margin-top: 0;">Location Info</h3>
                    <div id="weather-modal-location-details">
                      <p><strong>City:</strong> <span id="weather-modal-city">${userLocation.city}</span></p>
                      <p><strong>Country:</strong> <span id="weather-modal-country">${userLocation.country}</span></p>
                      <p><strong>Coordinates:</strong> <span id="weather-modal-coords">${userCoordinates.lat.toFixed(4)}, ${userCoordinates.lon.toFixed(4)}</span></p>
                      <p><strong>Local Time:</strong> <span id="weather-modal-time">${new Date().toLocaleTimeString()}</span></p>
                    </div>
                  </div>
                </div>
                
                <div style="text-align: center; margin-bottom: 1rem;">
                  <p>Weather data provided by OpenWeatherMap</p>
                </div>
                
                <div class="form-actions">
                  <button class="btn-secondary" onclick="closeModal('weather-modal')">Close</button>
                  <button class="btn-primary" onclick="getUserLocation(); showNotification('Weather data refreshed!', 'success');">Refresh Data</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Update modal with current weather data
      document.getElementById('weather-modal-location').textContent = userLocation.city;
      document.getElementById('weather-modal-icon').textContent = document.getElementById('weather-icon').textContent;
      document.getElementById('weather-modal-temp').textContent = document.getElementById('weather-temp').textContent;
      document.getElementById('weather-modal-desc').textContent = document.getElementById('weather-desc').textContent;
      document.getElementById('weather-modal-city').textContent = userLocation.city;
      document.getElementById('weather-modal-country').textContent = userLocation.country;
      document.getElementById('weather-modal-coords').textContent = `${userCoordinates.lat.toFixed(4)}, ${userCoordinates.lon.toFixed(4)}`;
      document.getElementById('weather-modal-time').textContent = new Date().toLocaleTimeString();
      
      // Get weather details from the main widget
      const weatherInfo = document.getElementById('weather-info').innerHTML;
      document.getElementById('weather-modal-details').innerHTML = weatherInfo;
      
      // Show modal
      document.getElementById('weather-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Viewed detailed weather for ${userLocation.city}`, 'weather-view');
      
      // Fetch 5-day forecast if API key is valid
      if (OPENWEATHER_API_KEY !== 'YOUR_API_KEY') {
        fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${userCoordinates.lat}&lon=${userCoordinates.lon}&units=metric&appid=${OPENWEATHER_API_KEY}`)
          .then(response => response.json())
          .then(data => {
            if (data && data.list) {
              // Process 5-day forecast data
              const forecastHTML = `
                <div style="margin-top: 1.5rem;">
                  <h3>5-Day Forecast</h3>
                  <div style="display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 1rem;">
                    ${processForecast(data.list)}
                  </div>
                </div>
              `;
              
              // Add forecast to modal
              document.getElementById('weather-modal-content').insertAdjacentHTML('beforeend', forecastHTML);
            }
          })
          .catch(error => {
            console.error('Error fetching forecast:', error);
          });
      }
    }
    
    // Helper function to process forecast data
    function processForecast(forecastList) {
      const dailyForecasts = {};
      
      // Group forecasts by day
      forecastList.forEach(item => {
        const date = new Date(item.dt * 1000);
        // Use ISO date format (YYYY-MM-DD) as key for consistent grouping
        const dayKey = date.toISOString().split('T')[0];
        
        if (!dailyForecasts[dayKey]) {
          dailyForecasts[dayKey] = {
            date: date, // Store the actual date object
            temps: [],
            icons: [],
            descriptions: []
          };
        }
        
        dailyForecasts[dayKey].temps.push(item.main.temp);
        dailyForecasts[dayKey].icons.push(item.weather[0].icon);
        dailyForecasts[dayKey].descriptions.push(item.weather[0].description);
      });
      
      // Sort by date (chronological order)
      const sortedForecasts = Object.values(dailyForecasts).sort((a, b) => a.date - b.date);
      
      // Create forecast cards
      return sortedForecasts.slice(0, 5).map(day => {
        // Calculate average temp and most common condition
        const avgTemp = day.temps.reduce((sum, temp) => sum + temp, 0) / day.temps.length;
        
        // Get most common icon
        const iconCounts = {};
        day.icons.forEach(icon => {
          iconCounts[icon] = (iconCounts[icon] || 0) + 1;
        });
        const mostCommonIcon = Object.entries(iconCounts).sort((a, b) => b[1] - a[1])[0][0];
        
        // Get most common description
        const descCounts = {};
        day.descriptions.forEach(desc => {
          descCounts[desc] = (descCounts[desc] || 0) + 1;
        });
        const mostCommonDesc = Object.entries(descCounts).sort((a, b) => b[1] - a[1])[0][0];
        
        // Format the date properly
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const forecastDate = new Date(day.date);
        forecastDate.setHours(0, 0, 0, 0);
        
        // Determine if it's today, tomorrow, or show the day name
        let dayLabel;
        if (forecastDate.getTime() === today.getTime()) {
          dayLabel = 'Today';
        } else if (forecastDate.getTime() === today.getTime() + 86400000) {
          dayLabel = 'Tomorrow';
        } else {
          dayLabel = forecastDate.toLocaleDateString('en-US', { weekday: 'short' });
        }
        
        return `
          <div style="flex: 1; min-width: 100px; background: var(--bg); padding: 0.8rem; border-radius: var(--radius); text-align: center;">
            <div style="font-weight: 600;">${dayLabel}</div>
            <div style="font-size: 0.8rem; opacity: 0.7;">${forecastDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
            <div style="font-size: 1.5rem; margin: 0.5rem 0;">${weatherIcons[mostCommonIcon] || '🌤️'}</div>
            <div style="font-weight: 600;">${Math.round(avgTemp)}°C</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">${mostCommonDesc.charAt(0).toUpperCase() + mostCommonDesc.slice(1)}</div>
          </div>
        `;
      }).join('');
    }
    
    // Update weather every 30 minutes
    setInterval(updateWeather, 1800000);

    // Device Management System - Functions using Database

    async function loadDevicesFromDB() {
      try {
        devices = await DatabaseAPI.getAllDevices();
        console.log(`📱 Loaded ${devices.length} devices from database`);
      } catch (error) {
        console.error('❌ Error loading devices:', error);
        devices = [];
      }
    }

    function openAddDeviceModal() {
      editingDeviceId = null;
      document.getElementById('device-modal-title').textContent = 'Add Device';
      document.getElementById('device-submit-btn').textContent = 'Add Device';
      document.querySelector('.device-form').reset();
      document.getElementById('device-modal').classList.add('show');
    }

    async function openEditDeviceModal(deviceId) {
      try {
        const device = await DatabaseAPI.getDevice(deviceId);
        if (!device) return;

        editingDeviceId = deviceId;
        document.getElementById('device-modal-title').textContent = 'Edit Device';
        document.getElementById('device-submit-btn').textContent = 'Update Device';
        
        document.getElementById('device-name').value = device.name;
        document.getElementById('device-type').value = device.type;
        document.getElementById('device-ip').value = device.ip || '';
        document.getElementById('device-mac').value = device.mac || '';
        document.getElementById('device-location').value = device.location || '';
        document.getElementById('device-owner').value = device.owner || '';
        document.getElementById('device-description').value = device.description || '';
        
        document.getElementById('device-modal').classList.add('show');
      } catch (error) {
        console.error('❌ Error opening edit modal:', error);
        showNotification('Error loading device details', 'error');
      }
    }

    async function handleDeviceSubmit(event) {
      event.preventDefault();
      
      try {
        const formData = new FormData(event.target);
        const deviceData = {
          name: formData.get('name'),
          type: formData.get('type'),
          ip: formData.get('ip') || generateRandomIP(),
          mac: formData.get('mac') || generateRandomMAC(),
          location: formData.get('location') || '',
          owner: formData.get('owner') || '',
          description: formData.get('description') || '',
          status: 'online',
          lastSeen: new Date().toISOString()
        };

        if (editingDeviceId) {
          // Update existing device
          deviceData.id = editingDeviceId;
          await DatabaseAPI.updateDevice(deviceData);
          showNotification(`✅ Device "${deviceData.name}" updated successfully!`, 'success');
          await addToActivityFeed(`📝 Device "${deviceData.name}" was updated`, 'device-update');
        } else {
          // Add new device
          await DatabaseAPI.addDevice(deviceData);
          showNotification(`🎉 Device "${deviceData.name}" added successfully!`, 'success');
          await addToActivityFeed(`➕ New device "${deviceData.name}" was added to the network`, 'device-add');
        }

        await loadDevicesFromDB();
        await renderDevices();
        updateDeviceStats();
        closeModal('device-modal');
      } catch (error) {
        console.error('❌ Error saving device:', error);
        showNotification('Error saving device. Please try again.', 'error');
      }
    }

    async function removeDevice(deviceId) {
      try {
        const device = await DatabaseAPI.getDevice(deviceId);
        if (!device) return;

        if (confirm(`Are you sure you want to remove "${device.name}" from the network?`)) {
          await DatabaseAPI.deleteDevice(deviceId);
          await loadDevicesFromDB();
          await renderDevices();
          updateDeviceStats();
          showNotification(`🗑️ Device "${device.name}" removed from network`, 'info');
          await addToActivityFeed(`❌ Device "${device.name}" was removed from the network`, 'device-remove');
        }
      } catch (error) {
        console.error('❌ Error removing device:', error);
        showNotification('Error removing device. Please try again.', 'error');
      }
    }

    function generateRandomIP() {
      return `192.168.1.${Math.floor(Math.random() * 200) + 50}`;
    }

    function generateRandomMAC() {
      const chars = '0123456789ABCDEF';
      let mac = '';
      for (let i = 0; i < 6; i++) {
        if (i > 0) mac += ':';
        mac += chars[Math.floor(Math.random() * 16)] + chars[Math.floor(Math.random() * 16)];
      }
      return mac;
    }

    function getDeviceStatusText(device) {
      const lastSeen = new Date(device.lastSeen);
      const now = new Date();
      const diffMinutes = Math.floor((now - lastSeen) / (1000 * 60));
      
      if (diffMinutes < 5) return 'Online';
      if (diffMinutes < 60) return `Last seen ${diffMinutes}m ago`;
      if (diffMinutes < 1440) return `Last seen ${Math.floor(diffMinutes / 60)}h ago`;
      return `Last seen ${Math.floor(diffMinutes / 1440)}d ago`;
    }

    async function renderDevices() {
      const devicesList = document.getElementById('devices-list');
      let filteredDevices = devices;
      
      if (currentDeviceFilter !== 'all') {
        filteredDevices = devices.filter(device => device.type === currentDeviceFilter);
      }

      if (filteredDevices.length === 0) {
        devicesList.innerHTML = `
          <div class="empty-devices">
            <div class="empty-devices-icon">📱</div>
            <h3>No Devices Found</h3>
            <p>${currentDeviceFilter === 'all' ? 'No devices have been added to the network yet.' : `No ${currentDeviceFilter} devices found.`}</p>
            ${currentDeviceFilter === 'all' ? '<button onclick="openAddDeviceModal()" class="btn-primary">Add Your First Device</button>' : ''}
          </div>
        `;
        return;
      }

      const filtersHTML = `
        <div class="devices-filter">
          <button class="filter-btn ${currentDeviceFilter === 'all' ? 'active' : ''}" onclick="setDeviceFilter('all')">All (${devices.length})</button>
          <button class="filter-btn ${currentDeviceFilter === 'laptop' ? 'active' : ''}" onclick="setDeviceFilter('laptop')">Laptops (${devices.filter(d => d.type === 'laptop').length})</button>
          <button class="filter-btn ${currentDeviceFilter === 'desktop' ? 'active' : ''}" onclick="setDeviceFilter('desktop')">Desktops (${devices.filter(d => d.type === 'desktop').length})</button>
          <button class="filter-btn ${currentDeviceFilter === 'mobile' ? 'active' : ''}" onclick="setDeviceFilter('mobile')">Mobile (${devices.filter(d => d.type === 'mobile').length})</button>
          <button class="filter-btn ${currentDeviceFilter === 'printer' ? 'active' : ''}" onclick="setDeviceFilter('printer')">Printers (${devices.filter(d => d.type === 'printer').length})</button>
          <button class="filter-btn ${currentDeviceFilter === 'server' ? 'active' : ''}" onclick="setDeviceFilter('server')">Servers (${devices.filter(d => d.type === 'server').length})</button>
        </div>
      `;

      const devicesHTML = filteredDevices.map(device => {
        const status = getDeviceStatus(device);
        const statusText = getDeviceStatusText(device);
        
        return `
          <div class="device-card" data-type="${device.type}">
            <div class="device-card-header">
              <div class="device-info">
                <div class="device-type-icon"></div>
                <div class="device-name">${device.name}</div>
                <div class="device-type">${device.type.charAt(0).toUpperCase() + device.type.slice(1)}</div>
                <div class="device-status">
                  <div class="status-indicator status-${status}"></div>
                  ${statusText}
                </div>
              </div>
            </div>
            
            <div class="device-details">
              ${device.ip ? `
                <div class="device-detail">
                  <div class="device-detail-label">IP Address</div>
                  <div class="device-detail-value">${device.ip}</div>
                </div>
              ` : ''}
              ${device.location ? `
                <div class="device-detail">
                  <div class="device-detail-label">Location</div>
                  <div class="device-detail-value">${device.location}</div>
                </div>
              ` : ''}
              ${device.owner ? `
                <div class="device-detail">
                  <div class="device-detail-label">Owner</div>
                  <div class="device-detail-value">${device.owner}</div>
                </div>
              ` : ''}
              ${device.mac ? `
                <div class="device-detail">
                  <div class="device-detail-label">MAC Address</div>
                  <div class="device-detail-value">${device.mac}</div>
                </div>
              ` : ''}
            </div>
            
            ${device.description ? `<p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">${device.description}</p>` : ''}
            
            <div class="device-actions">
              <button class="device-action-btn" onclick="openEditDeviceModal('${device.id}')">✏️ Edit</button>
              <button class="device-action-btn" onclick="pingDevice('${device.id}')">📡 Ping</button>
              <button class="device-action-btn danger" onclick="removeDevice('${device.id}')">🗑️ Remove</button>
            </div>
          </div>
        `;
      }).join('');

      devicesList.innerHTML = filtersHTML + '<div class="devices-grid">' + devicesHTML + '</div>';
    }

    function setDeviceFilter(filter) {
      currentDeviceFilter = filter;
      renderDevices();
    }

    function updateDeviceStats() {
      const totalDevices = devices.length;
      const onlineDevices = devices.filter(device => getDeviceStatus(device) === 'online').length;
      
      document.getElementById('total-devices').textContent = totalDevices;
      
      // Update dashboard metrics if they exist
      const dashboardDevices = document.getElementById('dashboard-devices');
      if (dashboardDevices) {
        dashboardDevices.textContent = onlineDevices;
      }
      
      // Update the dashboard metrics animation
      updateMetrics();
    }

    // Save devices to database
    async function saveDevices() {
      try {
        for (const device of devices) {
          await DatabaseAPI.updateDevice(device);
        }
      } catch (error) {
        console.error('❌ Error saving devices:', error);
        showNotification('Error saving device status. Please try again.', 'error');
      }
    }
    
    function pingDevice(deviceId) {
      const device = devices.find(d => d.id === deviceId);
      if (!device) return;

      // Simulate ping
      showNotification(`📡 Pinging ${device.name}...`, 'info');
      
      setTimeout(() => {
        const success = Math.random() > 0.2; // 80% success rate
        if (success) {
          const responseTime = Math.floor(Math.random() * 50) + 1;
          showNotification(`✅ ${device.name} responded in ${responseTime}ms`, 'success');
          
          // Update device status to online
          device.status = 'online';
          device.lastSeen = new Date().toISOString();
          saveDevices();
          renderDevices();
          updateDeviceStats();
        } else {
          showNotification(`❌ ${device.name} is not responding`, 'error');
          
          // Update device status to offline
          device.status = 'offline';
          saveDevices();
          renderDevices();
          updateDeviceStats();
        }
      }, 2000);
    }

    // Function to load device stats
    async function loadDeviceStats() {
      try {
        await loadDevicesFromDB();
        renderDevices();
        updateDeviceStats();
      } catch (error) {
        console.error('❌ Error loading device stats:', error);
      }
    }
    
    // Initialize device management
    loadDeviceStats();

    // Simulate random device status changes
    setInterval(() => {
      if (devices.length > 0 && Math.random() > 0.8) { // 20% chance every 30 seconds
        const randomDevice = devices[Math.floor(Math.random() * devices.length)];
        const currentStatus = getDeviceStatus(randomDevice);
        
        if (currentStatus === 'online' && Math.random() > 0.7) {
          // Device goes offline
          randomDevice.lastSeen = new Date(Date.now() - 3600000).toISOString(); // 1 hour ago
          addToActivityFeed(`📴 Device "${randomDevice.name}" went offline`, 'device-offline');
        } else if (currentStatus !== 'online' && Math.random() > 0.5) {
          // Device comes online
          randomDevice.lastSeen = new Date().toISOString();
          addToActivityFeed(`🟢 Device "${randomDevice.name}" came online`, 'device-online');
        }
        
        saveDevices();
        renderDevices();
        updateDeviceStats();
      }
    }, 30000);

    // Enhanced Calendar System with Event Management
    let currentDate = new Date(2025, 6, 9); // July 9, 2025
    let currentEditingEvent = null;
    let selectedDate = null;
    let calendarEvents = {}; // Will be loaded from IndexedDB
    
    // Load events from IndexedDB
    async function loadCalendarEvents() {
      try {
        const events = await DatabaseAPI.getAllEvents();
        calendarEvents = {};
        
        // Group events by date
        events.forEach(event => {
          const dateKey = event.date;
          if (!calendarEvents[dateKey]) {
            calendarEvents[dateKey] = [];
          }
          calendarEvents[dateKey].push(event);
        });
        
        // Regenerate calendar after loading events
        generateCalendar();
      } catch (error) {
        console.error('Failed to load calendar events:', error);
        calendarEvents = {};
      }
    }
    
    // Save event to IndexedDB
    async function saveEventToDatabase(event) {
      try {
        if (event.id) {
          await DatabaseAPI.updateEvent(event);
        } else {
          await DatabaseAPI.addEvent(event);
        }
        await loadCalendarEvents(); // Reload to refresh UI
      } catch (error) {
        console.error('Failed to save event:', error);
      }
    }
    
    // Delete event from IndexedDB
    async function deleteEventFromDatabase(eventId) {
      try {
        await DatabaseAPI.deleteEvent(eventId);
        await loadCalendarEvents(); // Reload to refresh UI
      } catch (error) {
        console.error('Failed to delete event:', error);
      }
    }
    
    // Generate calendar with enhanced functionality
    function generateCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      // Update month/year display
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                         'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
      
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      let calendarHTML = '';
      
      // Header
      days.forEach(day => {
        calendarHTML += `<div class="calendar-header">${day}</div>`;
      });
      
      // Previous month's trailing days
      const prevMonth = new Date(year, month - 1, 0);
      const prevMonthDays = prevMonth.getDate();
      for (let i = startingDayOfWeek - 1; i >= 0; i--) {
        calendarHTML += `<div class="calendar-day other-month">
          <div class="calendar-day-number">${prevMonthDays - i}</div>
        </div>`;
      }
      
      // Current month days
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
        const isSelected = selectedDate === dateStr;
        
        const dayEvents = calendarEvents[dateStr] || [];
        const eventsHTML = dayEvents.map(event => 
          `<div class="calendar-event ${event.priority}-priority" onclick="showEventDetails('${event.id}', event)" title="${event.title} - ${event.time}">
            ${event.title}
            <button class="calendar-event-delete" onclick="deleteEvent('${event.id}', event)">&times;</button>
          </div>`
        ).join('');
        
        let dayClasses = 'calendar-day';
        if (isToday) dayClasses += ' today';
        if (isSelected) dayClasses += ' selected';
        
        calendarHTML += `
          <div class="${dayClasses}" onclick="selectDate('${dateStr}')">
            <div class="calendar-day-number">${day}</div>
            ${eventsHTML}
          </div>
        `;
      }
      
      // Next month's leading days
      const remainingCells = 42 - (startingDayOfWeek + daysInMonth);
      for (let day = 1; day <= remainingCells; day++) {
        calendarHTML += `<div class="calendar-day other-month">
          <div class="calendar-day-number">${day}</div>
        </div>`;
      }
      
      return calendarHTML;
    }
    
    // Calendar navigation
    function changeMonth(direction) {
      currentDate.setMonth(currentDate.getMonth() + direction);
      document.getElementById('calendar-grid').innerHTML = generateCalendar();
    }
    
    // Select date
    function selectDate(dateStr) {
      selectedDate = dateStr;
      document.getElementById('calendar-grid').innerHTML = generateCalendar();
    }
    
    // Open add event modal
    function openAddEventModal(dateStr = null) {
      currentEditingEvent = null;
      document.getElementById('event-modal-title').textContent = 'Add New Event';
      document.getElementById('save-event-btn').textContent = 'Save Event';
      document.getElementById('delete-event-btn').style.display = 'none';
      
      // Clear form
      document.getElementById('event-title').value = '';
      document.getElementById('event-description').value = '';
      document.getElementById('event-date').value = dateStr || selectedDate || new Date().toISOString().split('T')[0];
      document.getElementById('event-priority').value = 'medium';
      document.getElementById('event-start-time').value = '09:00';
      document.getElementById('event-end-time').value = '10:00';
      document.getElementById('event-location').value = '';
      document.getElementById('event-attendees').value = '';
      
      document.getElementById('event-modal').classList.add('show');
    }
    
    // Save event
    async function saveEvent(event) {
      event.preventDefault();
      
      const title = document.getElementById('event-title').value;
      const description = document.getElementById('event-description').value;
      const date = document.getElementById('event-date').value;
      const priority = document.getElementById('event-priority').value;
      const startTime = document.getElementById('event-start-time').value;
      const endTime = document.getElementById('event-end-time').value;
      const location = document.getElementById('event-location').value;
      const attendees = document.getElementById('event-attendees').value;
      
      const eventData = {
        id: currentEditingEvent ? currentEditingEvent.id : undefined, // Let database generate ID for new events
        title,
        description,
        date,
        time: `${startTime}-${endTime}`,
        priority,
        location,
        attendees
      };
      
      try {
        await saveEventToDatabase(eventData);
        closeModal('event-modal');
        showNotification(`Event "${title}" ${currentEditingEvent ? 'updated' : 'created'} successfully!`, 'success');
        updateUpcomingEvents();
      } catch (error) {
        console.error('Failed to save event:', error);
        showNotification('Failed to save event. Please try again.', 'error');
      }
    }
    
    // Show event details
    function showEventDetails(eventId, event) {
      event.stopPropagation();
      
      // Find the event in the calendarEvents object
      let foundEvent = null;
      let eventDate = null;
      
      for (const [date, events] of Object.entries(calendarEvents)) {
        const foundInDate = events.find(e => e.id == eventId);
        if (foundInDate) {
          foundEvent = foundInDate;
          eventDate = foundInDate.date || date; // Use event.date if available, fallback to key
          break;
        }
      }
      
      if (!foundEvent) return;
      
      currentEditingEvent = { ...foundEvent, date: eventDate };
      
      const detailsHTML = `
        <div class="event-detail-item">
          <div class="event-detail-icon">📝</div>
          <div class="event-detail-content">
            <div class="event-detail-label">Title</div>
            <div class="event-detail-value">${foundEvent.title}</div>
          </div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-icon">📅</div>
          <div class="event-detail-content">
            <div class="event-detail-label">Date & Time</div>
            <div class="event-detail-value">${eventDate} at ${foundEvent.time}</div>
          </div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-icon">🔥</div>
          <div class="event-detail-content">
            <div class="event-detail-label">Priority</div>
            <div class="event-detail-value">${foundEvent.priority.charAt(0).toUpperCase() + foundEvent.priority.slice(1)}</div>
          </div>
        </div>
        
        ${foundEvent.location ? `
          <div class="event-detail-item">
            <div class="event-detail-icon">📍</div>
            <div class="event-detail-content">
              <div class="event-detail-label">Location</div>
              <div class="event-detail-value">${foundEvent.location}</div>
            </div>
          </div>
        ` : ''}
        
        ${foundEvent.attendees ? `
          <div class="event-detail-item">
            <div class="event-detail-icon">👥</div>
            <div class="event-detail-content">
              <div class="event-detail-label">Attendees</div>
              <div class="event-detail-value">${foundEvent.attendees}</div>
            </div>
          </div>
        ` : ''}
        
        ${foundEvent.description ? `
          <div class="event-detail-item">
            <div class="event-detail-icon">📄</div>
            <div class="event-detail-content">
              <div class="event-detail-label">Description</div>
              <div class="event-detail-value">${foundEvent.description}</div>
            </div>
          </div>
        ` : ''}
      `;
      
      document.getElementById('event-details-title').textContent = foundEvent.title;
      document.getElementById('event-details-content').innerHTML = detailsHTML;
      document.getElementById('event-details-modal').classList.add('show');
    }
    
    // Edit current event
    function editCurrentEvent() {
      if (!currentEditingEvent) return;
      
      closeModal('event-details-modal');
      
      document.getElementById('event-modal-title').textContent = 'Edit Event';
      document.getElementById('save-event-btn').textContent = 'Update Event';
      document.getElementById('delete-event-btn').style.display = 'block';
      
      // Populate form with event data
      document.getElementById('event-title').value = currentEditingEvent.title;
      document.getElementById('event-description').value = currentEditingEvent.description || '';
      document.getElementById('event-date').value = currentEditingEvent.date;
      document.getElementById('event-priority').value = currentEditingEvent.priority;
      
      const [startTime, endTime] = currentEditingEvent.time.split('-');
      document.getElementById('event-start-time').value = startTime;
      document.getElementById('event-end-time').value = endTime;
      document.getElementById('event-location').value = currentEditingEvent.location || '';
      document.getElementById('event-attendees').value = currentEditingEvent.attendees || '';
      
      document.getElementById('event-modal').classList.add('show');
    }
    
    // Delete event
    async function deleteEvent(eventId, event) {
      event.stopPropagation();
      
      if (!confirm('Are you sure you want to delete this event?')) return;
      
      try {
        await deleteEventFromDatabase(eventId);
        updateUpcomingEvents();
        showNotification('Event deleted successfully!', 'success');
      } catch (error) {
        console.error('Failed to delete event:', error);
        showNotification('Failed to delete event. Please try again.', 'error');
      }
    }
    
    // Delete current event from details modal
    async function deleteCurrentEvent() {
      if (!currentEditingEvent) return;
      
      if (!confirm('Are you sure you want to delete this event?')) return;
      
      try {
        await deleteEventFromDatabase(currentEditingEvent.id);
        closeModal('event-details-modal');
        closeModal('event-modal');
        updateUpcomingEvents();
        showNotification('Event deleted successfully!', 'success');
      } catch (error) {
        console.error('Failed to delete event:', error);
        showNotification('Failed to delete event. Please try again.', 'error');
      }
    }
    
    // Update upcoming events in main dashboard with clickable events
    function updateUpcomingEvents() {
      const today = new Date();
      const upcomingEvents = [];
      
      // Get events for next 30 days
      for (let i = 0; i < 30; i++) {
        const date = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const dayEvents = calendarEvents[dateStr] || [];
        
        dayEvents.forEach(event => {
          upcomingEvents.push({
            id: event.id,
            date: `${date.toLocaleDateString('en-US', { month: 'short' })} ${date.getDate()}`,
            title: event.title,
            time: event.time.split('-')[0],
            fullEvent: event,
            dateStr: dateStr
          });
        });
      }
      
      // Sort events by date and time
      upcomingEvents.sort((a, b) => {
        const dateA = new Date(a.dateStr + 'T' + a.time);
        const dateB = new Date(b.dateStr + 'T' + b.time);
        return dateA - dateB;
      });
      
      // Update the main dashboard events
      const eventsToShow = upcomingEvents.slice(0, 3);
      document.getElementById('calendar').innerHTML = eventsToShow.map(ev => `
        <div class="event" onclick="quickViewEvent('${ev.id}', '${ev.dateStr}')" style="cursor: pointer;">
          <span class="date">${ev.date}</span>
          <span>${ev.title}</span>
          <span style="margin-left:auto; color:var(--accent); font-weight:600;">${ev.time}</span>
        </div>
      `).join('');
    }
    
    // Quick view for events from the dashboard
    function quickViewEvent(eventId, dateStr) {
      // Find the event
      const events = calendarEvents[dateStr] || [];
      const event = events.find(e => e.id == eventId);
      
      if (!event) {
        showNotification('Event details not found', 'warning');
        return;
      }
      
      // Set as current editing event (for edit functionality)
      currentEditingEvent = { ...event, date: dateStr };
      
      // Show event details modal
      const detailsHTML = `
        <div class="event-detail-item">
          <div class="event-detail-icon">📝</div>
          <div class="event-detail-content">
            <div class="event-detail-label">Title</div>
            <div class="event-detail-value">${event.title}</div>
          </div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-icon">📅</div>
          <div class="event-detail-content">
            <div class="event-detail-label">Date & Time</div>
            <div class="event-detail-value">${dateStr} at ${event.time}</div>
          </div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-icon">🔥</div>
          <div class="event-detail-content">
            <div class="event-detail-label">Priority</div>
            <div class="event-detail-value">${event.priority.charAt(0).toUpperCase() + event.priority.slice(1)}</div>
          </div>
        </div>
        
        ${event.location ? `
          <div class="event-detail-item">
            <div class="event-detail-icon">📍</div>
            <div class="event-detail-content">
              <div class="event-detail-label">Location</div>
              <div class="event-detail-value">${event.location}</div>
            </div>
          </div>
        ` : ''}
        
        ${event.attendees ? `
          <div class="event-detail-item">
            <div class="event-detail-icon">👥</div>
            <div class="event-detail-content">
              <div class="event-detail-label">Attendees</div>
              <div class="event-detail-value">${event.attendees}</div>
            </div>
          </div>
        ` : ''}
        
        ${event.description ? `
          <div class="event-detail-item">
            <div class="event-detail-icon">📄</div>
            <div class="event-detail-content">
              <div class="event-detail-label">Description</div>
              <div class="event-detail-value">${event.description}</div>
            </div>
          </div>
        ` : ''}
      `;
      
      document.getElementById('event-details-title').textContent = event.title;
      document.getElementById('event-details-content').innerHTML = detailsHTML;
      document.getElementById('event-details-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Viewed event details: ${event.title}`, 'event-view');
    }

    // Real announcements with timestamps
    const realAnnouncements = [
      'Quarterly Town Hall: July 15, 10am - Join us for company updates and Q&A',
      'New wellness program launching Monday! Sign up in HR Portal',
      'Congratulations to DevOps team for achieving 99.99% uptime this quarter! 🎉',
      'Office cafeteria menu updated with new healthy options',
      'Reminder: Submit Q3 goals by Friday EOD'
    ];

    // Announcements with real data and clickable items
    document.getElementById('announcements').innerHTML = realAnnouncements.map((a, index) => `
      <li onclick="showAnnouncementDetails(${index})" style="cursor: pointer;">${a}</li>
    `).join('');
    
    // Function to show announcement details
    function showAnnouncementDetails(index) {
      const announcement = realAnnouncements[index];
      if (!announcement) return;
      
      // Extract title and content from announcement text
      const colonIndex = announcement.indexOf(':');
      let title = announcement;
      let content = '';
      
      if (colonIndex > -1) {
        title = announcement.substring(0, colonIndex + 1);
        content = announcement.substring(colonIndex + 1);
      }
      
      // Create modal content
      const modalContent = `
        <div style="padding: 1rem 0;">
          <p style="font-size: 1.1rem; font-weight: 600;">${title}</p>
          <p>${content}</p>
          
          <div style="background: var(--secondary); padding: 1rem; border-radius: 0.5rem; margin: 1.5rem 0;">
            <h4 style="margin-top: 0;">Additional Information</h4>
            <p>This announcement was posted by the Communications team. For more details, please contact <a href="javascript:void(0)">communications@axero.com</a>.</p>
          </div>
          
          <div class="form-actions">
            <button class="btn-secondary" onclick="closeModal('announcement-details-modal')">Close</button>
            <button class="btn-primary" onclick="showNotification('Reminder set for this announcement', 'success'); closeModal('announcement-details-modal');">Set Reminder</button>
          </div>
        </div>
      `;
      
      // Create modal if it doesn't exist
      if (!document.getElementById('announcement-details-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="announcement-details-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('announcement-details-modal')">&times;</button>
              <h2>Announcement Details</h2>
              <div id="announcement-details-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Update and show modal
      document.getElementById('announcement-details-content').innerHTML = modalContent;
      document.getElementById('announcement-details-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Viewed announcement: ${title}`, 'announcement-view');
    }

    // Team Spotlights with interactive cards
    const spotlights = [
      { 
        name: 'Priya Patel', 
        role: 'Lead Designer', 
        img: 'https://randomuser.me/api/portraits/women/44.jpg', 
        feature: 'Redesigned the mobile app UI',
        achievement: 'Led the complete redesign of our mobile application interface, resulting in a 35% increase in user engagement and a 28% decrease in user-reported issues.',
        quote: 'Good design is about making complex things simple and intuitive for users.'
      },
      { 
        name: 'Carlos Gomez', 
        role: 'Backend Engineer', 
        img: 'https://randomuser.me/api/portraits/men/32.jpg', 
        feature: 'Optimized API response times by 40%',
        achievement: 'Completely refactored our API architecture and implemented caching strategies that reduced average response times from 850ms to 510ms.',
        quote: 'Performance isn\'t just a feature, it\'s a fundamental requirement for good user experience.'
      },
      { 
        name: 'Jin Lee', 
        role: 'QA Analyst', 
        img: 'https://randomuser.me/api/portraits/men/65.jpg', 
        feature: 'Automated 200+ test cases',
        achievement: 'Developed a comprehensive automated testing framework that reduced manual testing time by 70% while increasing test coverage by 45%.',
        quote: 'Quality is never an accident; it is always the result of intelligent effort.'
      }
    ];
    
    document.getElementById('spotlights').innerHTML = spotlights.map(e => `
      <div class="employee-card" onclick="showSpotlightDetails('${e.name}')" style="cursor: pointer;">
        <img src="${e.img}" alt="${e.name}" />
        <div class="employee-info">
          <div class="name">${e.name}</div>
          <div class="role">${e.role}</div>
          <div class="feature">${e.feature}</div>
        </div>
      </div>
    `).join('');
    
    // Function to show spotlight details
    function showSpotlightDetails(name) {
      const spotlight = spotlights.find(s => s.name === name);
      if (!spotlight) return;
      
      // Find employee in directory for additional info
      const employee = directory.find(e => e.name === name) || {};
      
      // Create modal content
      const modalContent = `
        <div style="padding: 0.5rem 0;">
          <div style="display: flex; gap: 1.5rem; align-items: center; margin-bottom: 1.5rem;">
            <img src="${spotlight.img}" alt="${spotlight.name}" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent);" />
            <div>
              <h3 style="margin: 0; color: var(--primary);">${spotlight.name}</h3>
              <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">${spotlight.role}</div>
              <div style="color: var(--text); opacity: 0.8;">${employee.department || ''} ${employee.department ? '•' : ''} ${employee.location || ''}</div>
            </div>
          </div>
          
          <div style="background: var(--secondary); padding: 1.2rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
            <h4 style="margin-top: 0;">Achievement Spotlight</h4>
            <p>${spotlight.achievement}</p>
          </div>
          
          <div style="font-style: italic; font-size: 1.1rem; color: var(--primary); text-align: center; padding: 1rem; border-left: 3px solid var(--accent); margin-bottom: 1.5rem;">
            "${spotlight.quote}"
          </div>
          
          <div class="form-actions">
            <button class="btn-secondary" onclick="closeModal('spotlight-modal')">Close</button>
            <button class="btn-primary" onclick="openMessageComposer(); document.getElementById('message-to').value = '${spotlight.name}'; document.getElementById('message-subject').value = 'Congratulations on your spotlight!'; closeModal('spotlight-modal');">Send Congratulations</button>
          </div>
        </div>
      `;
      
      // Create modal if it doesn't exist
      if (!document.getElementById('spotlight-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="spotlight-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('spotlight-modal')">&times;</button>
              <h2>Team Spotlight</h2>
              <div id="spotlight-modal-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Update and show modal
      document.getElementById('spotlight-modal-content').innerHTML = modalContent;
      document.getElementById('spotlight-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Viewed team spotlight: ${spotlight.name}`, 'spotlight-view');
    }

    // Calendar Events with real data from calendar system
    updateUpcomingEvents();

    // Resources with enhanced working links
    const resources = [
      { 
        name: 'HR Portal', 
        id: 'hr-portal',
        icon: '👩‍💼',
        description: 'Access HR services, benefits information, and company policies',
        quickLinks: [
          { name: 'Request Time Off', action: 'requestTimeOff()' },
          { name: 'Benefits Portal', action: 'openBenefitsPortal()' },
          { name: 'Company Directory', action: 'openCompanyDirectory()' },
          { name: 'Training Catalog', action: 'openTrainingCatalog()' }
        ]
      },
      { 
        name: 'IT Helpdesk', 
        id: 'it-helpdesk',
        icon: '🖥️',
        description: 'Get technical support, request equipment, and access IT resources',
        quickLinks: [
          { name: 'Submit Ticket', action: 'openTicketForm()' },
          { name: 'Request Equipment', action: 'requestEquipment()' },
          { name: 'Software Catalog', action: 'openSoftwareCatalog()' },
          { name: 'Password Reset', action: 'resetPassword()' }
        ]
      },
      { 
        name: 'Knowledge Base', 
        id: 'knowledge-base',
        icon: '📚',
        description: 'Access company documentation, guides, and best practices',
        quickLinks: [
          { name: 'Company Policies', action: 'openPolicies()' },
          { name: 'How-to Guides', action: 'openHowToGuides()' },
          { name: 'Product Documentation', action: 'openProductDocs()' },
          { name: 'FAQ', action: 'openFAQ()' }
        ]
      },
      { 
        name: 'Cafeteria Menu', 
        id: 'cafeteria-menu',
        icon: '🍽️',
        description: 'View today\'s menu, special offers, and dietary information',
        quickLinks: [
          { name: 'Today\'s Specials', action: 'viewTodaysSpecials()' },
          { name: 'Weekly Menu', action: 'viewWeeklyMenu()' },
          { name: 'Dietary Options', action: 'viewDietaryOptions()' },
          { name: 'Order Online', action: 'orderMeal()' }
        ]
      }
    ];
    
    document.getElementById('resources').innerHTML = resources.map(r => `
      <a href="javascript:openEnhancedResource('${r.id}')" class="resource-link" tabindex="0">${r.icon} ${r.name}</a>
    `).join('');
    
    // Function to open enhanced resource
    function openEnhancedResource(resourceId) {
      const resource = resources.find(r => r.id === resourceId);
      if (!resource) return;
      
      // Create modal if it doesn't exist
      if (!document.getElementById('enhanced-resource-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="enhanced-resource-modal">
            <div class="modal" style="width: 800px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('enhanced-resource-modal')">&times;</button>
              <div id="enhanced-resource-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <div id="enhanced-resource-icon" style="font-size: 2.5rem;"></div>
                <div>
                  <h2 id="enhanced-resource-title" style="margin: 0;"></h2>
                  <p id="enhanced-resource-description" style="margin: 0.5rem 0 0 0; opacity: 0.8;"></p>
                </div>
              </div>
              <div id="enhanced-resource-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Update modal header
      document.getElementById('enhanced-resource-icon').textContent = resource.icon;
      document.getElementById('enhanced-resource-title').textContent = resource.name;
      document.getElementById('enhanced-resource-description').textContent = resource.description;
      
      // Generate content based on resource type
      let content = '';
      
      switch(resourceId) {
        case 'hr-portal':
          content = generateHRPortalContent(resource);
          break;
        case 'it-helpdesk':
          content = generateITHelpdeskContent(resource);
          break;
        case 'knowledge-base':
          content = generateKnowledgeBaseContent(resource);
          break;
        case 'cafeteria-menu':
          content = generateCafeteriaMenuContent(resource);
          break;
        default:
          content = `
            <div style="text-align: center; padding: 2rem;">
              <p>Resource content not available</p>
            </div>
          `;
      }
      
      // Update and show modal
      document.getElementById('enhanced-resource-content').innerHTML = content;
      document.getElementById('enhanced-resource-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Accessed ${resource.name} resource`, 'resource-access');
    }
    
    // Generate HR Portal content
    function generateHRPortalContent(resource) {
      return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
          <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
            <h3 style="margin-top: 0;">Quick Links</h3>
            <div style="display: flex; flex-direction: column; gap: 0.8rem;">
              ${resource.quickLinks.map(link => `
                <a href="javascript:${link.action}" class="resource-link">${link.name}</a>
              `).join('')}
            </div>
          </div>
          
          <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
            <h3 style="margin-top: 0;">Recent Announcements</h3>
            <ul style="padding-left: 1.2rem;">
              <li>New wellness program starting next week</li>
              <li>Annual performance reviews begin August 1st</li>
              <li>Updated travel policy now available</li>
            </ul>
          </div>
        </div>
        
        <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
          <h3 style="margin-top: 0;">Time Off Balance</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <div>
              <div style="font-size: 2rem; font-weight: 600; color: var(--primary);">15</div>
              <div>Vacation Days</div>
            </div>
            <div>
              <div style="font-size: 2rem; font-weight: 600; color: var(--primary);">5</div>
              <div>Sick Days</div>
            </div>
            <div>
              <div style="font-size: 2rem; font-weight: 600; color: var(--primary);">2</div>
              <div>Personal Days</div>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn-secondary" onclick="closeModal('enhanced-resource-modal')">Close</button>
          <button class="btn-primary" onclick="requestTimeOff()">Request Time Off</button>
        </div>
      `;
    }
    
    // Generate IT Helpdesk content
    function generateITHelpdeskContent(resource) {
      return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
          <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
            <h3 style="margin-top: 0;">Quick Links</h3>
            <div style="display: flex; flex-direction: column; gap: 0.8rem;">
              ${resource.quickLinks.map(link => `
                <a href="javascript:${link.action}" class="resource-link">${link.name}</a>
              `).join('')}
            </div>
          </div>
          
          <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
            <h3 style="margin-top: 0;">System Status</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Email</span>
                <span style="color: #10b981;">✓ Operational</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>VPN</span>
                <span style="color: #10b981;">✓ Operational</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>CRM</span>
                <span style="color: #f59e0b;">⚠ Degraded Performance</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>File Server</span>
                <span style="color: #10b981;">✓ Operational</span>
              </div>
            </div>
          </div>
        </div>
        
        <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
          <h3 style="margin-top: 0;">Submit a Ticket</h3>
          <div class="form-group">
            <label for="ticket-subject">Subject</label>
            <input type="text" id="ticket-subject" placeholder="Brief description of the issue" />
          </div>
          <div class="form-group">
            <label for="ticket-description">Description</label>
            <textarea id="ticket-description" placeholder="Please provide details about your issue..." rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="ticket-priority">Priority</label>
            <select id="ticket-priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn-secondary" onclick="closeModal('enhanced-resource-modal')">Close</button>
          <button class="btn-primary" onclick="submitITTicket()">Submit Ticket</button>
        </div>
      `;
    }
    
    // Generate Knowledge Base content
    function generateKnowledgeBaseContent(resource) {
      return `
        <div style="margin-bottom: 1.5rem;">
          <div class="form-group">
            <input type="text" placeholder="Search knowledge base..." style="width: 100%" />
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
          <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
            <h3 style="margin-top: 0;">Quick Links</h3>
            <div style="display: flex; flex-direction: column; gap: 0.8rem;">
              ${resource.quickLinks.map(link => `
                <a href="javascript:${link.action}" class="resource-link">${link.name}</a>
              `).join('')}
            </div>
          </div>
          
          <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
            <h3 style="margin-top: 0;">Popular Articles</h3>
            <ul style="padding-left: 1.2rem;">
              <li><a href="javascript:showArticle('Company VPN Setup Guide')">Company VPN Setup Guide</a></li>
              <li><a href="javascript:showArticle('Expense Reporting Process')">Expense Reporting Process</a></li>
              <li><a href="javascript:showArticle('New Hire Onboarding Checklist')">New Hire Onboarding Checklist</a></li>
              <li><a href="javascript:showArticle('Project Management Best Practices')">Project Management Best Practices</a></li>
            </ul>
          </div>
        </div>
        
        <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
          <h3 style="margin-top: 0;">Recently Updated</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div style="background: var(--bg); padding: 1rem; border-radius: var(--radius);">
              <h4 style="margin-top: 0;">Remote Work Policy</h4>
              <p style="margin-bottom: 0;">Updated 2 days ago</p>
              <a href="javascript:showArticle('Remote Work Policy')">Read more</a>
            </div>
            <div style="background: var(--bg); padding: 1rem; border-radius: var(--radius);">
              <h4 style="margin-top: 0;">Data Security Guidelines</h4>
              <p style="margin-bottom: 0;">Updated 5 days ago</p>
              <a href="javascript:showArticle('Data Security Guidelines')">Read more</a>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn-secondary" onclick="closeModal('enhanced-resource-modal')">Close</button>
          <button class="btn-primary" onclick="openHowToGuides()">Browse All Articles</button>
        </div>
      `;
    }
    
    // Generate Cafeteria Menu content
    function generateCafeteriaMenuContent(resource) {
      return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
          <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
            <h3 style="margin-top: 0;">Quick Links</h3>
            <div style="display: flex; flex-direction: column; gap: 0.8rem;">
              ${resource.quickLinks.map(link => `
                <a href="javascript:${link.action}" class="resource-link">${link.name}</a>
              `).join('')}
            </div>
          </div>
          
          <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
            <h3 style="margin-top: 0;">Today's Hours</h3>
            <p><strong>Breakfast:</strong> 7:30 AM - 9:30 AM</p>
            <p><strong>Lunch:</strong> 11:30 AM - 2:00 PM</p>
            <p><strong>Coffee Bar:</strong> 7:30 AM - 3:00 PM</p>
          </div>
        </div>
        
        <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
          <h3 style="margin-top: 0;">Today's Specials</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div style="background: var(--bg); padding: 1rem; border-radius: var(--radius);">
              <h4 style="margin-top: 0;">Main Course</h4>
              <p><strong>Grilled Salmon</strong> with lemon butter sauce</p>
              <p><em>Served with roasted vegetables and quinoa</em></p>
              <p>Calories: 520 | Protein: 32g | $12.95</p>
            </div>
            <div style="background: var(--bg); padding: 1rem; border-radius: var(--radius);">
              <h4 style="margin-top: 0;">Vegetarian Option</h4>
              <p><strong>Mediterranean Wrap</strong> with hummus</p>
              <p><em>Served with side salad and fruit cup</em></p>
              <p>Calories: 450 | Protein: 15g | $9.95</p>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn-secondary" onclick="closeModal('enhanced-resource-modal')">Close</button>
          <button class="btn-primary" onclick="orderMeal()">Order Online</button>
        </div>
      `;
    }
    
    // Resource action functions
    function requestTimeOff() {
      showNotification('Time off request form opened', 'success');
      closeModal('enhanced-resource-modal');
      // In a real implementation, this would open a time off request form
    }
    
    function openBenefitsPortal() {
      showNotification('Benefits portal opened in a new tab', 'success');
      // In a real implementation, this would open the benefits portal in a new tab
    }
    
    function openCompanyDirectory() {
      closeModal('enhanced-resource-modal');
      // Simulate opening the directory by focusing on that section
      document.getElementById('directory-title').scrollIntoView({ behavior: 'smooth' });
      setTimeout(() => {
        document.getElementById('directory-title').style.color = 'var(--accent)';
        setTimeout(() => {
          document.getElementById('directory-title').style.color = 'var(--primary)';
        }, 2000);
      }, 500);
    }
    
    function openTrainingCatalog() {
      showNotification('Training catalog opened', 'success');
      // In a real implementation, this would open the training catalog
    }
    
    function openTicketForm() {
      // Focus on the ticket form that's already in the IT helpdesk modal
      document.getElementById('ticket-subject').focus();
    }
    
    function requestEquipment() {
      closeModal('enhanced-resource-modal');
      openAddDeviceModal();
    }
    
    function openSoftwareCatalog() {
      showNotification('Software catalog opened', 'success');
      // In a real implementation, this would open the software catalog
    }
    
    function resetPassword() {
      showNotification('Password reset instructions sent to your email', 'success');
      // In a real implementation, this would initiate a password reset
    }
    
    function openPolicies() {
      showNotification('Company policies opened', 'success');
      // In a real implementation, this would open company policies
    }
    
    function openHowToGuides() {
      showNotification('How-to guides opened', 'success');
      // In a real implementation, this would open how-to guides
    }
    
    function openProductDocs() {
      showNotification('Product documentation opened', 'success');
      // In a real implementation, this would open product documentation
    }
    
    function openFAQ() {
      showNotification('FAQ opened', 'success');
      // In a real implementation, this would open the FAQ
    }
    
    function viewTodaysSpecials() {
      // Focus on the today's specials section that's already in the cafeteria menu modal
      document.querySelector('#enhanced-resource-content h3').scrollIntoView({ behavior: 'smooth' });
    }
    
    function viewWeeklyMenu() {
      showNotification('Weekly menu opened', 'success');
      // In a real implementation, this would open the weekly menu
    }
    
    function viewDietaryOptions() {
      showNotification('Dietary options opened', 'success');
      // In a real implementation, this would open dietary options
    }
    
    function orderMeal() {
      showNotification('Online meal ordering opened', 'success');
      // In a real implementation, this would open the meal ordering system
    }
    
    // Function to open resource modals
    function openResourceModal(resourceType) {
      let title = '';
      let content = '';
      
      switch(resourceType) {
        case 'hr-portal':
          title = 'HR Portal';
          content = `
            <div style="padding: 1rem 0;">
              <h3>HR Services</h3>
              <ul>
                <li><a href="javascript:showNotification('Benefits portal opened in a new tab', 'success')">Benefits & Insurance</a></li>
                <li><a href="javascript:showNotification('Time off request submitted', 'success')">Request Time Off</a></li>
                <li><a href="javascript:showNotification('Payroll portal opened', 'success')">Payroll Information</a></li>
                <li><a href="javascript:showNotification('Training catalog opened', 'success')">Training & Development</a></li>
              </ul>
              
              <h3>Recent Updates</h3>
              <p>New wellness program starting next week! Sign up by Friday.</p>
              <p>Annual performance reviews begin August 1st.</p>
              
              <div class="form-actions">
                <button class="btn-primary" onclick="showNotification('HR request submitted successfully!', 'success'); closeModal('resource-modal')">Contact HR</button>
              </div>
            </div>
          `;
          break;
          
        case 'it-helpdesk':
          title = 'IT Helpdesk';
          content = `
            <div style="padding: 1rem 0;">
              <h3>Common Issues</h3>
              <ul>
                <li><a href="javascript:showNotification('Password reset instructions sent to your email', 'success')">Reset Password</a></li>
                <li><a href="javascript:showNotification('VPN setup guide opened', 'success')">VPN Setup</a></li>
                <li><a href="javascript:showNotification('Software request submitted', 'success')">Request Software</a></li>
                <li><a href="javascript:showNotification('Hardware request form opened', 'success')">Request Hardware</a></li>
              </ul>
              
              <h3>Submit a Ticket</h3>
              <div class="form-group">
                <label for="ticket-subject">Subject</label>
                <input type="text" id="ticket-subject" placeholder="Brief description of the issue" />
              </div>
              <div class="form-group">
                <label for="ticket-description">Description</label>
                <textarea id="ticket-description" placeholder="Please provide details about your issue..." rows="3"></textarea>
              </div>
              <div class="form-group">
                <label for="ticket-priority">Priority</label>
                <select id="ticket-priority">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                </select>
              </div>
              
              <div class="form-actions">
                <button class="btn-primary" onclick="submitITTicket()">Submit Ticket</button>
              </div>
            </div>
          `;
          break;
          
        case 'knowledge-base':
          title = 'Knowledge Base';
          content = `
            <div style="padding: 1rem 0;">
              <div class="form-group">
                <input type="text" placeholder="Search knowledge base..." style="width: 100%" />
              </div>
              
              <h3>Popular Articles</h3>
              <ul>
                <li><a href="javascript:showArticle('Company VPN Setup Guide')">Company VPN Setup Guide</a></li>
                <li><a href="javascript:showArticle('Expense Reporting Process')">Expense Reporting Process</a></li>
                <li><a href="javascript:showArticle('New Hire Onboarding Checklist')">New Hire Onboarding Checklist</a></li>
                <li><a href="javascript:showArticle('Project Management Best Practices')">Project Management Best Practices</a></li>
                <li><a href="javascript:showArticle('Company Security Policies')">Company Security Policies</a></li>
              </ul>
              
              <h3>Categories</h3>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <a href="javascript:showNotification('HR policies category opened', 'info')" class="resource-link">HR Policies</a>
                <a href="javascript:showNotification('IT support category opened', 'info')" class="resource-link">IT Support</a>
                <a href="javascript:showNotification('Project management category opened', 'info')" class="resource-link">Project Management</a>
                <a href="javascript:showNotification('Company policies category opened', 'info')" class="resource-link">Company Policies</a>
              </div>
            </div>
          `;
          break;
          
        case 'cafeteria-menu':
          title = 'Cafeteria Menu';
          content = `
            <div style="padding: 1rem 0;">
              <h3>Today's Specials</h3>
              <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                <div style="flex: 1; min-width: 200px; background: var(--secondary); padding: 1rem; border-radius: 0.5rem;">
                  <h4 style="margin-top: 0;">Main Course</h4>
                  <p><strong>Grilled Salmon</strong> with lemon butter sauce</p>
                  <p><em>Served with roasted vegetables and quinoa</em></p>
                  <p>Calories: 520 | Protein: 32g | $12.95</p>
                </div>
                <div style="flex: 1; min-width: 200px; background: var(--secondary); padding: 1rem; border-radius: 0.5rem;">
                  <h4 style="margin-top: 0;">Vegetarian Option</h4>
                  <p><strong>Mediterranean Wrap</strong> with hummus</p>
                  <p><em>Served with side salad and fruit cup</em></p>
                  <p>Calories: 450 | Protein: 15g | $9.95</p>
                </div>
              </div>
              
              <h3>Weekly Menu</h3>
              <ul>
                <li><strong>Monday:</strong> Pasta Bar</li>
                <li><strong>Tuesday:</strong> Taco Tuesday</li>
                <li><strong>Wednesday:</strong> Chef's Choice (Today)</li>
                <li><strong>Thursday:</strong> International Cuisine</li>
                <li><strong>Friday:</strong> Grill & BBQ Day</li>
              </ul>
              
              <p><em>Hours: 7:30 AM - 3:00 PM, Monday-Friday</em></p>
              <p>Questions or dietary concerns? Contact our cafeteria manager at <a href="javascript:void(0)">cafeteria@axero.com</a></p>
            </div>
          `;
          break;
      }
      
      // Create modal if it doesn't exist
      if (!document.getElementById('resource-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="resource-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('resource-modal')">&times;</button>
              <h2 id="resource-modal-title"></h2>
              <div id="resource-modal-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Update and show modal
      document.getElementById('resource-modal-title').textContent = title;
      document.getElementById('resource-modal-content').innerHTML = content;
      document.getElementById('resource-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Accessed ${title} resource`, 'resource-access');
    }
    
    // Function to show knowledge base article
    function showArticle(articleTitle) {
      const articleContent = `
        <div style="padding: 1rem 0;">
          <h3>${articleTitle}</h3>
          <p><em>Last updated: July 5, 2025 | Author: Axero Knowledge Team</em></p>
          <hr style="margin: 1rem 0;">
          <p>This is a sample article content for "${articleTitle}". In a real implementation, this would contain the full article text with proper formatting, images, and links.</p>
          <p>The article would provide detailed information and step-by-step instructions related to the topic.</p>
          <p>For demonstration purposes, we're showing this placeholder content instead.</p>
          
          <div style="background: var(--secondary); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0;">
            <h4>Related Articles</h4>
            <ul>
              <li><a href="javascript:showArticle('Related Topic 1')">Related Topic 1</a></li>
              <li><a href="javascript:showArticle('Related Topic 2')">Related Topic 2</a></li>
            </ul>
          </div>
          
          <div class="form-actions">
            <button class="btn-secondary" onclick="openResourceModal('knowledge-base')">Back to Knowledge Base</button>
            <button class="btn-primary" onclick="showNotification('Article PDF downloaded', 'success')">Download PDF</button>
          </div>
        </div>
      `;
      
      document.getElementById('resource-modal-title').textContent = articleTitle;
      document.getElementById('resource-modal-content').innerHTML = articleContent;
      
      // Add to activity feed
      addToActivityFeed(`Viewed knowledge base article: ${articleTitle}`, 'knowledge-access');
    }
    
    // Function to submit IT ticket
    function submitITTicket() {
      const subject = document.getElementById('ticket-subject').value;
      const description = document.getElementById('ticket-description').value;
      const priority = document.getElementById('ticket-priority').value;
      
      if (!subject || !description) {
        showNotification('Please fill in all required fields', 'warning');
        return;
      }
      
      // Generate ticket number
      const ticketNumber = 'IT-' + Math.floor(10000 + Math.random() * 90000);
      
      showNotification(`IT Ticket #${ticketNumber} submitted successfully! We'll respond within 24 hours.`, 'success');
      closeModal('resource-modal');
      
      // Add to activity feed
      addToActivityFeed(`Submitted IT ticket: ${subject}`, 'ticket-submission');
    }

    // Communication Hub with interactive elements
    const comms = [
      { icon: '🔔', msg: '3 new messages in #general', action: 'openChatChannel("general")' },
      { icon: '📢', msg: 'Company-wide update: Remote Fridays extended!', action: 'openAnnouncement("remote-fridays")' },
      { icon: '💬', msg: 'Feedback requested on new benefits plan', action: 'openFeedbackForm("benefits-plan")' }
    ];
    document.getElementById('comm-hub').innerHTML = comms.map(c => `
      <div class="comm-update" onclick="${c.action}" style="cursor: pointer;">
        <span class="icon">${c.icon}</span> ${c.msg}
      </div>
    `).join('');
    
    // Communication Hub interaction functions
    function openChatChannel(channel) {
      // Open chat and simulate channel selection
      toggleChat();
      showNotification(`Switched to #${channel} channel`, 'info');
      
      // Add a simulated message from the channel
      setTimeout(async () => {
        await addChatMessage(`Welcome to #${channel}! There are 3 unread messages.`, false);
      }, 500);
      
      // Add to activity feed
      addToActivityFeed(`Opened #${channel} chat channel`, 'chat-access');
    }
    
    function openAnnouncement(id) {
      // Create modal content based on announcement ID
      let title = '';
      let content = '';
      
      switch(id) {
        case 'remote-fridays':
          title = 'Remote Fridays Extended';
          content = `
            <div style="padding: 1rem 0;">
              <p><strong>Date:</strong> July 8, 2025</p>
              <p><strong>From:</strong> Sarah Johnson, HR Director</p>
              <hr style="margin: 1rem 0;">
              
              <p>Dear Team,</p>
              
              <p>We're pleased to announce that our Remote Fridays program has been extended indefinitely due to its overwhelming success and positive feedback!</p>
              
              <p>Since implementing this program six months ago:</p>
              <ul>
                <li>Employee satisfaction has increased by 22%</li>
                <li>Productivity metrics have improved by 15%</li>
                <li>Carbon footprint reduced by eliminating one day of commuting per week</li>
              </ul>
              
              <p>Please continue to follow the same procedures for Remote Fridays:</p>
              <ul>
                <li>Ensure your calendar is up to date</li>
                <li>Be available during core hours (10am-3pm)</li>
                <li>Check in with your team lead at the start of your day</li>
              </ul>
              
              <p>Thank you for making this initiative a success!</p>
              
              <p>Best regards,<br>Sarah Johnson<br>HR Director</p>
              
              <div class="form-actions">
                <button class="btn-secondary" onclick="closeModal('announcement-modal')">Close</button>
                <button class="btn-primary" onclick="showNotification('Feedback submitted. Thank you!', 'success'); closeModal('announcement-modal')">Send Feedback</button>
              </div>
            </div>
          `;
          break;
      }
      
      // Create modal if it doesn't exist
      if (!document.getElementById('announcement-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="announcement-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('announcement-modal')">&times;</button>
              <h2 id="announcement-modal-title"></h2>
              <div id="announcement-modal-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Update and show modal
      document.getElementById('announcement-modal-title').textContent = title;
      document.getElementById('announcement-modal-content').innerHTML = content;
      document.getElementById('announcement-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Read announcement: ${title}`, 'announcement-read');
    }
    
    function openFeedbackForm(id) {
      // Create modal content based on feedback form ID
      let title = '';
      let content = '';
      
      switch(id) {
        case 'benefits-plan':
          title = 'Benefits Plan Feedback';
          content = `
            <div style="padding: 1rem 0;">
              <p>We're updating our benefits package for the upcoming year and would love your input! Please take a moment to share your thoughts on the proposed changes.</p>
              
              <div class="form-group">
                <label for="benefits-rating">How would you rate the current benefits package?</label>
                <select id="benefits-rating">
                  <option value="5">Excellent</option>
                  <option value="4">Very Good</option>
                  <option value="3" selected>Good</option>
                  <option value="2">Fair</option>
                  <option value="1">Poor</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Which benefits are most important to you? (Select up to 3)</label>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                  <label style="display: flex; align-items: center; gap: 0.3rem;">
                    <input type="checkbox" name="benefits" value="health"> Health Insurance
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.3rem;">
                    <input type="checkbox" name="benefits" value="dental"> Dental Coverage
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.3rem;">
                    <input type="checkbox" name="benefits" value="vision"> Vision Coverage
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.3rem;">
                    <input type="checkbox" name="benefits" value="retirement"> 401(k) Matching
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.3rem;">
                    <input type="checkbox" name="benefits" value="pto"> Paid Time Off
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.3rem;">
                    <input type="checkbox" name="benefits" value="wellness"> Wellness Program
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.3rem;">
                    <input type="checkbox" name="benefits" value="education"> Education Assistance
                  </label>
                </div>
              </div>
              
              <div class="form-group">
                <label for="benefits-suggestions">Do you have any suggestions for improving our benefits package?</label>
                <textarea id="benefits-suggestions" rows="4" placeholder="Your suggestions here..."></textarea>
              </div>
              
              <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closeModal('feedback-modal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="submitFeedback()">Submit Feedback</button>
              </div>
            </div>
          `;
          break;
      }
      
      // Create modal if it doesn't exist
      if (!document.getElementById('feedback-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="feedback-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('feedback-modal')">&times;</button>
              <h2 id="feedback-modal-title"></h2>
              <div id="feedback-modal-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Update and show modal
      document.getElementById('feedback-modal-title').textContent = title;
      document.getElementById('feedback-modal-content').innerHTML = content;
      document.getElementById('feedback-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Opened feedback form: ${title}`, 'feedback-form');
    }
    
    function submitFeedback() {
      showNotification('Thank you for your feedback! Your input helps us improve our benefits package.', 'success');
      closeModal('feedback-modal');
      
      // Add to activity feed
      addToActivityFeed('Submitted benefits plan feedback', 'feedback-submission');
    }

    // Employee Directory with enhanced functionality
    const directory = [
      { 
        id: 'emp1',
        name: 'Priya Patel', 
        role: 'Lead Designer', 
        contact: 'priya@axero.com', 
        phone: '+1-555-0123', 
        img: 'https://randomuser.me/api/portraits/women/44.jpg', 
        department: 'Design', 
        location: 'San Francisco',
        bio: 'Priya leads our design team with over 8 years of UX/UI experience. She specializes in creating intuitive user experiences and has led the redesign of our mobile app.',
        skills: ['UI/UX Design', 'Figma', 'Adobe Creative Suite', 'Design Systems', 'User Research']
      },
      { 
        id: 'emp2',
        name: 'Carlos Gomez', 
        role: 'Backend Engineer', 
        contact: 'carlos@axero.com', 
        phone: '+1-555-0124', 
        img: 'https://randomuser.me/api/portraits/men/32.jpg', 
        department: 'Engineering', 
        location: 'Remote',
        bio: 'Carlos is a backend specialist with expertise in API development and database optimization. He recently improved our API response times by 40%.',
        skills: ['Node.js', 'Python', 'MongoDB', 'AWS', 'Docker']
      },
      { 
        id: 'emp3',
        name: 'Jin Lee', 
        role: 'QA Analyst', 
        contact: 'jin@axero.com', 
        phone: '+1-555-0125', 
        img: 'https://randomuser.me/api/portraits/men/65.jpg', 
        department: 'Quality Assurance', 
        location: 'New York',
        bio: 'Jin ensures our products meet the highest quality standards. He has automated over 200 test cases and implemented our continuous testing pipeline.',
        skills: ['Selenium', 'Jest', 'Cypress', 'Test Automation', 'CI/CD']
      },
      { 
        id: 'emp4',
        name: 'Alex Morgan', 
        role: 'Product Manager', 
        contact: 'alex@axero.com', 
        phone: '+1-555-0126', 
        img: 'https://randomuser.me/api/portraits/men/12.jpg', 
        department: 'Product', 
        location: 'San Francisco',
        bio: 'Alex leads our product strategy and roadmap planning. He has successfully launched 5 major product updates in the past year.',
        skills: ['Product Strategy', 'Agile', 'Market Research', 'User Stories', 'Roadmapping']
      }
    ];
    
    document.getElementById('directory').innerHTML = directory.map(e => `
      <div class="directory-card" onclick="openEmployeeProfile('${e.id}')">
        <img src="${e.img}" alt="${e.name}" />
        <div class="directory-info">
          <div class="name">${e.name}</div>
          <div class="role">${e.role}</div>
          <div class="contact">${e.contact}</div>
        </div>
      </div>
    `).join('');
    
    // Enhanced employee profile function
    function openEmployeeProfile(employeeId) {
      const employee = directory.find(e => e.id === employeeId);
      if (!employee) return;
      
      // Create modal if it doesn't exist
      if (!document.getElementById('employee-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="employee-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('employee-modal')">&times;</button>
              <div id="employee-modal-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Generate employee profile content
      const content = `
        <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
          <img src="${employee.img}" alt="${employee.name}" style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary);" />
          <div>
            <h2 style="margin-top: 0; color: var(--primary);">${employee.name}</h2>
            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">${employee.role}</div>
            <div style="color: var(--text); opacity: 0.8; margin-bottom: 0.5rem;">${employee.department} • ${employee.location}</div>
          </div>
        </div>
        
        <div style="margin: 1.5rem 0; padding: 1rem; background: var(--secondary); border-radius: var(--radius);">
          <h3 style="margin-top: 0;">Contact Information</h3>
          <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem;">
            <div style="font-weight: 600;">Email:</div>
            <div><a href="mailto:${employee.contact}" style="color: var(--primary);">${employee.contact}</a></div>
            <div style="font-weight: 600;">Phone:</div>
            <div><a href="tel:${employee.phone}" style="color: var(--primary);">${employee.phone}</a></div>
            <div style="font-weight: 600;">Department:</div>
            <div>${employee.department}</div>
            <div style="font-weight: 600;">Location:</div>
            <div>${employee.location}</div>
          </div>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
          <h3>About</h3>
          <p>${employee.bio}</p>
        </div>
        
        <div>
          <h3>Skills</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            ${employee.skills.map(skill => `
              <span style="background: var(--secondary); padding: 0.3rem 0.8rem; border-radius: 1rem; font-size: 0.9rem;">${skill}</span>
            `).join('')}
          </div>
        </div>
        
        <div class="form-actions" style="margin-top: 2rem;">
          <button class="btn-secondary" onclick="closeModal('employee-modal')">Close</button>
          <button class="btn-primary" onclick="openMessageComposer(); document.getElementById('message-to').value = '${employee.name} <${employee.contact}>'; closeModal('employee-modal');">Send Message</button>
        </div>
      `;
      
      // Update and show modal
      document.getElementById('employee-modal-content').innerHTML = content;
      document.getElementById('employee-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Viewed ${employee.name}'s profile`, 'profile-view');
    }
    
    // Legacy function for backward compatibility
    function showEmployeeDetails(name, role, email, phone, department, location) {
      const employee = directory.find(e => e.name === name);
      if (employee) {
        openEmployeeProfile(employee.id);
      } else {
        const details = `
          <strong>${name}</strong><br>
          ${role}<br>
          📧 ${email}<br>
          📞 ${phone}<br>
          🏢 ${department}<br>
          📍 ${location}
        `;
        showNotification(details, 'info');
      }
    }

    // Weather Widget (now using real data from updateWeather function)
    // Initial weather update is called above

    // Employee Recognition with interactive cards
    const recognition = [
      { 
        name: 'Alex Morgan', 
        reason: 'Employee of the Month - Led successful product launch', 
        img: 'https://randomuser.me/api/portraits/men/12.jpg',
        details: 'Alex led the successful launch of our new product suite, coordinating across 5 departments and ensuring all deadlines were met. The launch resulted in a 22% increase in new customer sign-ups.',
        nominatedBy: 'Sarah Johnson, CEO',
        date: 'July 2025'
      },
      { 
        name: 'Priya Patel', 
        reason: 'Best Team Player - Mentored 3 junior designers', 
        img: 'https://randomuser.me/api/portraits/women/44.jpg',
        details: 'Priya has gone above and beyond in mentoring our new junior designers. She created a comprehensive onboarding program and dedicated extra time to ensure their success while maintaining her own project deadlines.',
        nominatedBy: 'Design Department',
        date: 'June 2025'
      }
    ];
    
    document.getElementById('recognition').innerHTML = recognition.map(e => `
      <div class="employee-card" onclick="showRecognitionDetails('${e.name}')" style="cursor: pointer;">
        <img src="${e.img}" alt="${e.name}" />
        <div class="employee-info">
          <div class="name">${e.name}</div>
          <div class="feature">${e.reason}</div>
        </div>
      </div>
    `).join('');
    
    // Function to show recognition details
    function showRecognitionDetails(name) {
      const award = recognition.find(r => r.name === name);
      if (!award) return;
      
      // Create modal content
      const modalContent = `
        <div style="padding: 0.5rem 0;">
          <div style="text-align: center; margin-bottom: 1.5rem;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">🏆</div>
            <h3 style="margin: 0; color: var(--primary);">${award.reason.split(' - ')[0]}</h3>
            <div style="font-size: 1.1rem; color: var(--accent);">${award.date}</div>
          </div>
          
          <div style="display: flex; gap: 1.5rem; align-items: center; margin-bottom: 1.5rem;">
            <img src="${award.img}" alt="${award.name}" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent);" />
            <div>
              <h3 style="margin: 0; color: var(--primary);">${award.name}</h3>
              <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">${award.reason.split(' - ')[1]}</div>
              <div style="color: var(--text); opacity: 0.8;">Nominated by: ${award.nominatedBy}</div>
            </div>
          </div>
          
          <div style="background: var(--secondary); padding: 1.2rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
            <h4 style="margin-top: 0;">Achievement Details</h4>
            <p>${award.details}</p>
          </div>
          
          <div class="form-actions">
            <button class="btn-secondary" onclick="closeModal('recognition-modal')">Close</button>
            <button class="btn-primary" onclick="openMessageComposer(); document.getElementById('message-to').value = '${award.name}'; document.getElementById('message-subject').value = 'Congratulations on your recognition!'; closeModal('recognition-modal');">Send Congratulations</button>
          </div>
        </div>
      `;
      
      // Create modal if it doesn't exist
      if (!document.getElementById('recognition-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="recognition-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('recognition-modal')">&times;</button>
              <h2>Employee Recognition</h2>
              <div id="recognition-modal-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Update and show modal
      document.getElementById('recognition-modal-content').innerHTML = modalContent;
      document.getElementById('recognition-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Viewed recognition details for ${award.name}`, 'recognition-view');
    }

    // Project Status with enhanced progress bars and interactive elements
    const projects = [
      { 
        id: 'proj1',
        name: 'Intranet Redesign', 
        percent: 80,
        lead: 'Priya Patel',
        deadline: '2025-08-15',
        status: 'On Track',
        description: 'Redesigning the company intranet portal with modern UI/UX principles and improved functionality.',
        tasks: [
          { name: 'User Research', status: 'Completed', assignee: 'Priya Patel' },
          { name: 'Wireframing', status: 'Completed', assignee: 'Design Team' },
          { name: 'UI Development', status: 'In Progress', assignee: 'Frontend Team' },
          { name: 'Backend Integration', status: 'In Progress', assignee: 'Carlos Gomez' },
          { name: 'Testing', status: 'Not Started', assignee: 'Jin Lee' }
        ]
      },
      { 
        id: 'proj2',
        name: 'Mobile App v2', 
        percent: 55,
        lead: 'Alex Morgan',
        deadline: '2025-09-30',
        status: 'At Risk',
        description: 'Major update to our mobile application with new features and improved performance.',
        tasks: [
          { name: 'Feature Planning', status: 'Completed', assignee: 'Alex Morgan' },
          { name: 'UI Design', status: 'Completed', assignee: 'Priya Patel' },
          { name: 'Frontend Development', status: 'In Progress', assignee: 'Mobile Team' },
          { name: 'API Development', status: 'Delayed', assignee: 'Carlos Gomez' },
          { name: 'QA Testing', status: 'Not Started', assignee: 'Jin Lee' }
        ]
      },
      { 
        id: 'proj3',
        name: 'Cloud Migration', 
        percent: 92,
        lead: 'Carlos Gomez',
        deadline: '2025-07-31',
        status: 'On Track',
        description: 'Migrating our infrastructure to cloud services for improved scalability and reliability.',
        tasks: [
          { name: 'Infrastructure Planning', status: 'Completed', assignee: 'Carlos Gomez' },
          { name: 'Data Migration Strategy', status: 'Completed', assignee: 'Database Team' },
          { name: 'Test Environment Setup', status: 'Completed', assignee: 'DevOps Team' },
          { name: 'Production Migration', status: 'In Progress', assignee: 'Carlos Gomez' },
          { name: 'Performance Testing', status: 'In Progress', assignee: 'Jin Lee' }
        ]
      }
    ];
    
    document.getElementById('project-status').innerHTML = projects.map(p => `
      <div style="margin-bottom:1rem; cursor: pointer;" onclick="openProjectDetails('${p.id}')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="font-weight:600; color:var(--primary);">${p.name}</div>
          <div style="font-size:0.85rem; padding: 0.2rem 0.6rem; border-radius: 1rem; background: ${p.status === 'On Track' ? '#10b981' : p.status === 'At Risk' ? '#f59e0b' : '#ef4444'}; color: white;">${p.status}</div>
        </div>
        <div class="progress-bar"><div class="progress" style="width:${p.percent}%"></div></div>
        <div style="display: flex; justify-content: space-between; font-size:0.92rem; color:var(--text); opacity:0.8;">
          <div>${p.percent}% complete</div>
          <div>Due: ${new Date(p.deadline).toLocaleDateString()}</div>
        </div>
      </div>
    `).join('');
    
    // Function to open project details
    function openProjectDetails(projectId) {
      const project = projects.find(p => p.id === projectId);
      if (!project) return;
      
      // Create modal content
      const modalContent = `
        <div style="padding: 0.5rem 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div>
              <h3 style="margin: 0; color: var(--primary);">${project.name}</h3>
              <div>Led by ${project.lead} • Due ${new Date(project.deadline).toLocaleDateString()}</div>
            </div>
            <div style="font-size:0.9rem; padding: 0.3rem 0.8rem; border-radius: 1rem; background: ${project.status === 'On Track' ? '#10b981' : project.status === 'At Risk' ? '#f59e0b' : '#ef4444'}; color: white;">${project.status}</div>
          </div>
          
          <div class="progress-bar" style="height: 0.8rem; margin-bottom: 1rem;">
            <div class="progress" style="width:${project.percent}%"></div>
          </div>
          
          <p>${project.description}</p>
          
          <h4>Tasks</h4>
          <div style="background: var(--secondary); border-radius: 0.5rem; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--primary); color: white;">
                  <th style="padding: 0.7rem; text-align: left;">Task</th>
                  <th style="padding: 0.7rem; text-align: left;">Status</th>
                  <th style="padding: 0.7rem; text-align: left;">Assignee</th>
                </tr>
              </thead>
              <tbody>
                ${project.tasks.map(task => `
                  <tr style="border-bottom: 1px solid var(--bg);">
                    <td style="padding: 0.7rem;">${task.name}</td>
                    <td style="padding: 0.7rem;">
                      <span style="padding: 0.2rem 0.5rem; border-radius: 0.3rem; font-size: 0.8rem; background: ${task.status === 'Completed' ? '#10b981' : task.status === 'In Progress' ? '#3b82f6' : task.status === 'Delayed' ? '#ef4444' : '#6b7280'}; color: white;">
                        ${task.status}
                      </span>
                    </td>
                    <td style="padding: 0.7rem;">${task.assignee}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div class="form-actions" style="margin-top: 1.5rem;">
            <button class="btn-secondary" onclick="closeModal('project-modal')">Close</button>
            <button class="btn-primary" onclick="showNotification('Project report downloaded', 'success'); closeModal('project-modal');">Download Report</button>
          </div>
        </div>
      `;
      
      // Create modal if it doesn't exist
      if (!document.getElementById('project-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="project-modal">
            <div class="modal" style="width: 700px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('project-modal')">&times;</button>
              <div id="project-modal-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Update and show modal
      document.getElementById('project-modal-content').innerHTML = modalContent;
      document.getElementById('project-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Viewed project details: ${project.name}`, 'project-view');
    }

    // Activity Feed with real timestamps - Dynamic system
    let activities = []; // Loaded from IndexedDB in initialization

    // Deprecated - activity management now handled by DatabaseAPI in initializeApp()
    function saveActivities() {
      // No-op - activities are now saved directly via DatabaseAPI
    }

    async function addToActivityFeed(action, type, user = 'System') {
      try {
        const newActivity = {
          user: user === 'System' ? '🖥️' : user.substring(0, 2).toUpperCase(),
          action: action,
          time: 'just now',
          type: type,
          timestamp: new Date().toISOString()
        };

        await DatabaseAPI.addActivity(newActivity);
        await renderActivityFeed();
      } catch (error) {
        console.error('❌ Error adding activity:', error);
      }
    }

    function getTimeAgo(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diffMs = now - time;
      const diffMins = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    }

    async function renderActivityFeed() {
      try {
        const activities = await DatabaseAPI.getRecentActivities(6);
        
        // Update time stamps for all activities
        activities.forEach(activity => {
          activity.time = getTimeAgo(activity.timestamp);
        });

        document.getElementById('activity-feed').innerHTML = activities.map(a => `
          <div class="activity-item">
            <div class="activity-avatar">${a.user}</div>
            <div class="activity-content">${a.action}</div>
            <div class="activity-time">${a.time}</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('❌ Error rendering activity feed:', error);
      }
    }

    // Initial render of activity feed
    renderActivityFeed();
    
    // Update activity feed times every minute
    setInterval(renderActivityFeed, 60000);

    // Real Chat System with persistent messages
    let chatMessages = []; // Will be loaded from IndexedDB
    
    // Load chat messages from IndexedDB
    async function loadChatMessages() {
      try {
        chatMessages = await DatabaseAPI.getChatMessages();
        if (chatMessages.length === 0) {
          // Add default messages if none exist
          const defaultMessages = [
            { text: "Hi! How can I help you today?", isUser: false, timestamp: new Date() },
            { text: "Welcome to the team chat! Feel free to ask questions or share updates.", isUser: false, timestamp: new Date() }
          ];
          for (const msg of defaultMessages) {
            await DatabaseAPI.addChatMessage(msg);
          }
          chatMessages = await DatabaseAPI.getChatMessages();
        }
        renderChatMessages();
      } catch (error) {
        console.error('Failed to load chat messages:', error);
        chatMessages = [];
      }
    }

    // Chat System
    async function toggleChat() {
      const panel = document.getElementById('chat-panel');
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) {
        await loadChatMessages();
      }
    }

    function renderChatMessages() {
      const messagesContainer = document.getElementById('chat-messages');
      messagesContainer.innerHTML = chatMessages.map(msg => `
        <div class="chat-message ${msg.isUser ? 'user' : ''}">
          ${msg.text}
          <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 0.2rem;">
            ${msg.timestamp.toLocaleTimeString()}
          </div>
        </div>
      `).join('');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function handleChatInput(event) {
      if (event.key === 'Enter') {
        const input = event.target;
        const message = input.value.trim();
        if (message) {
          await addChatMessage(message, true);
          input.value = '';
          
          // Simulate intelligent responses
          setTimeout(async () => {
            const responses = getIntelligentResponse(message);
            await addChatMessage(responses);
          }, 1000 + Math.random() * 2000);
        }
      }
    }

    async function addChatMessage(message, isUser = false) {
      const chatMessage = {
        text: message,
        isUser: isUser,
        timestamp: new Date()
      };
      
      try {
        await DatabaseAPI.addChatMessage(chatMessage);
        await loadChatMessages(); // Reload to update UI
      } catch (error) {
        console.error('Failed to save chat message:', error);
        // Fallback to local update if database fails
        chatMessages.push(chatMessage);
        renderChatMessages();
      }
    }

    function getIntelligentResponse(userMessage) {
      const msg = userMessage.toLowerCase();
      
      if (msg.includes('weather')) {
        return "Current weather in SF: Check the weather widget on the main dashboard!";
      } else if (msg.includes('calendar') || msg.includes('meeting')) {
        return "You can view the full calendar by clicking the calendar quick action button. Upcoming: Sprint Review today at 2pm!";
      } else if (msg.includes('help') || msg.includes('support')) {
        return "For IT support, contact it-support@axero.com. For HR questions, reach out to hr@axero.com. You can also click the help button for more info!";
      } else if (msg.includes('lunch') || msg.includes('food')) {
        return "Today's lunch menu includes grilled salmon, quinoa salad, and veggie wraps. Check the cafeteria menu link in resources!";
      } else if (msg.includes('project')) {
        return "Current projects: Intranet Redesign (80%), Mobile App v2 (55%), Cloud Migration (92%). Check the project status section for details!";
      } else {
        const genericResponses = [
          "Thanks for your message! Someone will get back to you soon.",
          "That's a great question. Let me check on that for you.",
          "I've noted your request. Is there anything else I can help with?",
          "Thanks for the update! Keep up the great work.",
          "Got it! I'll make sure the right team sees this message."
        ];
        return genericResponses[Math.floor(Math.random() * genericResponses.length)];
      }
    }

    // Modal Management with enhanced calendar
    function openCalendar() {
      document.getElementById('calendar-grid').innerHTML = generateCalendar();
      updateUpcomingEvents();
      document.getElementById('calendar-modal').classList.add('show');
    }

    function openMessageComposer() {
      document.getElementById('message-modal').classList.add('show');
    }

    function openHelp() {
      document.getElementById('help-modal').classList.add('show');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // Send real messages
    function sendMessage(event) {
      event.preventDefault();
      const to = document.getElementById('message-to').value;
      const subject = document.getElementById('message-subject').value;
      const body = document.getElementById('message-body').value;
      
      // Simulate sending message
      showNotification(`Message sent to ${to}!`, 'success');
      
      // Add to activity feed
      const newActivity = {
        user: 'You',
        action: `Sent message to ${to}: "${subject}"`,
        time: 'Just now',
        type: 'message'
      };
      
      activities.unshift(newActivity);
      document.getElementById('activity-feed').innerHTML = activities.slice(0, 6).map(a => `
        <div class="activity-item">
          <div class="activity-avatar">${a.user}</div>
          <div class="activity-content">${a.action}</div>
          <div class="activity-time">${a.time}</div>
        </div>
      `).join('');
      
      // Clear form and close modal
      document.getElementById('message-to').value = '';
      document.getElementById('message-subject').value = '';
      document.getElementById('message-body').value = '';
      closeModal('message-modal');
    }

    // Show employee details
    function showEmployeeDetails(name, role, email, phone, department, location) {
      const details = `
        <strong>${name}</strong><br>
        ${role}<br>
        📧 ${email}<br>
        📞 ${phone}<br>
        🏢 ${department}<br>
        📍 ${location}
      `;
      showNotification(details, 'info');
    }

    // Notification System (enhanced for HTML content)
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.innerHTML = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, type === 'info' ? 5000 : 3000); // Longer display for info messages
    }

    // Enhanced Search Functionality with clickable results
    document.getElementById('global-search').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      if (query.length > 2) {
        // Search through real data
        const searchResults = [];
        
        // Search in directory
        directory.forEach(person => {
          if (person.name.toLowerCase().includes(query) || 
              person.role.toLowerCase().includes(query) ||
              person.department.toLowerCase().includes(query)) {
            searchResults.push({
              type: 'person',
              id: person.id,
              icon: '👤',
              text: `${person.name} - ${person.role}`,
              action: `openEmployeeProfile('${person.id}')`
            });
          }
        });
        
        // Search in projects
        projects.forEach(project => {
          if (project.name.toLowerCase().includes(query)) {
            searchResults.push({
              type: 'project',
              id: project.id,
              icon: '📋',
              text: `${project.name} - ${project.percent}% complete`,
              action: `openProjectDetails('${project.id}')`
            });
          }
        });
        
        // Search in announcements
        realAnnouncements.forEach((announcement, index) => {
          if (announcement.toLowerCase().includes(query)) {
            searchResults.push({
              type: 'announcement',
              id: index,
              icon: '📢',
              text: `${announcement.substring(0, 50)}...`,
              action: `showAnnouncementDetails(${index})`
            });
          }
        });
        
        // Search in events
        Object.entries(calendarEvents).forEach(([dateStr, events]) => {
          events.forEach(event => {
            if (event.title.toLowerCase().includes(query) || 
                (event.description && event.description.toLowerCase().includes(query))) {
              searchResults.push({
                type: 'event',
                id: event.id,
                icon: '📅',
                text: `${event.title} - ${dateStr} at ${event.time.split('-')[0]}`,
                action: `quickViewEvent('${event.id}', '${dateStr}')`
              });
            }
          });
        });
        
        if (searchResults.length > 0) {
          // Create search results modal
          showSearchResults(query, searchResults);
        } else {
          showNotification(`No results found for "${query}"`, 'warning');
        }
      }
    });
    
    // Function to show search results in a modal
    function showSearchResults(query, results) {
      // Create modal if it doesn't exist
      if (!document.getElementById('search-results-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="search-results-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('search-results-modal')">&times;</button>
              <h2>Search Results</h2>
              <div id="search-results-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Generate results HTML
      const resultsHTML = `
        <div style="margin-bottom: 1rem;">
          <p>Found ${results.length} results for "<strong>${query}</strong>"</p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          ${results.slice(0, 10).map(result => `
            <div class="search-result-item" onclick="${result.action}; closeModal('search-results-modal');" style="display: flex; align-items: center; gap: 0.8rem; background: var(--secondary); padding: 0.8rem; border-radius: var(--radius); cursor: pointer; transition: all 0.2s ease;">
              <div style="font-size: 1.5rem;">${result.icon}</div>
              <div>
                <div>${result.text}</div>
                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 0.2rem;">${result.type.charAt(0).toUpperCase() + result.type.slice(1)}</div>
              </div>
            </div>
          `).join('')}
        </div>
        ${results.length > 10 ? `<p style="text-align: center; margin-top: 1rem;">Showing 10 of ${results.length} results</p>` : ''}
      `;
      
      // Update and show modal
      document.getElementById('search-results-content').innerHTML = resultsHTML;
      document.getElementById('search-results-modal').classList.add('show');
      
      // Add hover effect to search results
      document.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('mouseover', function() {
          this.style.background = 'var(--primary)';
          this.style.color = 'white';
          this.style.transform = 'translateY(-2px)';
        });
        
        item.addEventListener('mouseout', function() {
          this.style.background = 'var(--secondary)';
          this.style.color = 'var(--text)';
          this.style.transform = 'translateY(0)';
        });
      });
      
      // Add to activity feed
      addToActivityFeed(`Searched for "${query}"`, 'search');
    }

    // Add smooth loading animations to sections
    function addLoadingAnimations() {
      const sections = document.querySelectorAll('section');
      sections.forEach((section, index) => {
        section.style.opacity = '0';
        section.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
          section.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          section.style.opacity = '1';
          section.style.transform = 'translateY(0)';
        }, index * 100);
      });
    }

    // Initialize animations on page load
    window.addEventListener('load', addLoadingAnimations);

    // Dark mode toggle
    const darkToggle = document.querySelector('.dark-toggle');
    darkToggle.addEventListener('click', () => {
      const theme = document.documentElement.getAttribute('data-theme');
      if (theme === 'dark') {
        document.documentElement.removeAttribute('data-theme');
        darkToggle.textContent = '🌙 Dark Mode';
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        darkToggle.textContent = '☀️ Light Mode';
      }
    });
    // Keyboard accessibility for dark mode toggle
    darkToggle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        darkToggle.click();
      }
    });
    // Enhanced real-time updates with real data changes
    setInterval(() => {
      const n = Math.floor(Math.random() * 3);
      
      // Update metrics with realistic variations
      const newUsers = 120 + Math.floor(Math.random() * 20);
      const newSatisfaction = 95 + Math.floor(Math.random() * 5);
      
      document.getElementById('active-users').textContent = newUsers;
      document.getElementById('satisfaction').textContent = newSatisfaction + '%';
      
      // Update metric bars
      document.getElementById('users-bar').style.width = (newUsers / 150 * 100) + '%';
      document.getElementById('satisfaction-bar').style.width = newSatisfaction + '%';
      
      // Animate a communication update
      const commHub = document.getElementById('comm-hub');
      if (commHub.children[n]) {
        commHub.children[n].style.background = 'var(--accent)';
        commHub.children[n].style.color = '#fff';
        commHub.children[n].style.transform = 'scale(1.02)';
        
        setTimeout(() => {
          commHub.children[n].style.background = 'var(--secondary)';
          commHub.children[n].style.color = 'var(--text)';
          commHub.children[n].style.transform = 'scale(1)';
        }, 700);
      }
      
      // Add new realistic activities
      const newActivities = [
        { user: 'New', action: 'System health check completed', time: 'Just now', type: 'system' },
        { user: 'Bot', action: 'Weekly report generated', time: 'Just now', type: 'report' },
        { user: 'IT', action: 'Security patch deployed', time: 'Just now', type: 'update' },
        { user: 'HR', action: 'New policy document published', time: 'Just now', type: 'announcement' }
      ];
      
      if (Math.random() < 0.4) {
        const newActivity = newActivities[Math.floor(Math.random() * newActivities.length)];
        activities.unshift(newActivity);
        
        // Re-render activity feed with latest 6 items
        document.getElementById('activity-feed').innerHTML = activities.slice(0, 6).map(a => `
          <div class="activity-item">
            <div class="activity-avatar">${a.user}</div>
            <div class="activity-content">${a.action}</div>
            <div class="activity-time">${a.time}</div>
          </div>
        `).join('');
        
        // Show notification for new activity
        showNotification(`📊 New activity: ${newActivity.action}`, 'info');
      }
      
      // Update weather occasionally (simulate changes)
      if (Math.random() < 0.1) {
        updateWeather();
        showNotification('🌤️ Weather updated!', 'info');
      }
    }, 8000); // Increased interval for more realistic updates
    
    // Add keyboard shortcuts with real functionality
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + K for search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('global-search').focus();
        showNotification('🔍 Search activated! Start typing to find people, projects, or documents...', 'info');
      }
      
      // Ctrl/Cmd + D for dark mode
      if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
        e.preventDefault();
        document.querySelector('.dark-toggle').click();
      }
      
      // Ctrl/Cmd + M for message composer
      if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
        e.preventDefault();
        openMessageComposer();
      }
      
      // Ctrl/Cmd + C for calendar
      if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        e.preventDefault();
        openCalendar();
      }
      
      // Ctrl/Cmd + E for device management (Equipment)
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        openAddDeviceModal();
      }
      
      // Ctrl/Cmd + N for new event (when calendar is open)
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        if (document.getElementById('calendar-modal').classList.contains('show')) {
          openAddEventModal();
        } else {
          // If no modal is open, open device modal
          openAddDeviceModal();
        }
      }
      
      // Escape to close modals
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.show').forEach(modal => {
          modal.classList.remove('show');
        });
      }
    });
    
    // Add click outside to close modals
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('show');
      }
    });
    
    // Role-based access control
    function setupRoleBasedAccess() {
      if (!currentUser) return;
      
      // Define permissions based on role
      const isAdmin = currentUser.role === 'Administrator';
      
      // Admin-only features
      const adminElements = document.querySelectorAll('.admin-only');
      adminElements.forEach(el => {
        el.style.display = isAdmin ? '' : 'none';
      });
      
      // Add admin badge if user is admin
      if (isAdmin) {
        const adminBadge = document.createElement('div');
        adminBadge.style.position = 'absolute';
        adminBadge.style.top = '1.5rem';
        adminBadge.style.left = '2rem';
        adminBadge.style.background = 'var(--accent)';
        adminBadge.style.color = '#000';
        adminBadge.style.padding = '0.3rem 0.8rem';
        adminBadge.style.borderRadius = '1rem';
        adminBadge.style.fontWeight = '600';
        adminBadge.style.fontSize = '0.8rem';
        adminBadge.textContent = 'Admin';
        document.querySelector('header').appendChild(adminBadge);
        
        // Add admin panel button
        const adminButton = document.createElement('button');
        adminButton.className = 'quick-action';
        adminButton.title = 'Admin Panel';
        adminButton.innerHTML = '⚙️';
        adminButton.onclick = openAdminPanel;
        document.querySelector('.quick-actions').prepend(adminButton);
      }
      
      // Modify device management based on role
      if (!isAdmin) {
        // Regular users can view but not add/edit devices
        document.querySelectorAll('.btn-add-device').forEach(btn => {
          btn.style.display = 'none';
        });
      }
    }
    
    // Admin panel
    function openAdminPanel() {
      // Create modal if it doesn't exist
      if (!document.getElementById('admin-panel-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="admin-panel-modal">
            <div class="modal" style="width: 800px; max-width: 95vw;">
              <button class="modal-close" onclick="closeModal('admin-panel-modal')">&times;</button>
              <h2>Admin Panel</h2>
              
              <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn-primary" onclick="showAdminSection('users')">User Management</button>
                <button class="btn-primary" onclick="showAdminSection('system')">System Settings</button>
                <button class="btn-primary" onclick="showAdminSection('logs')">Activity Logs</button>
              </div>
              
              <div id="admin-content">
                <div id="admin-users" style="display: none;">
                  <h3>User Management</h3>
                  <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                    <thead>
                      <tr style="background: var(--primary); color: white;">
                        <th style="padding: 0.7rem; text-align: left;">Username</th>
                        <th style="padding: 0.7rem; text-align: left;">Name</th>
                        <th style="padding: 0.7rem; text-align: left;">Email</th>
                        <th style="padding: 0.7rem; text-align: left;">Role</th>
                        <th style="padding: 0.7rem; text-align: left;">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr style="border-bottom: 1px solid var(--secondary);">
                        <td style="padding: 0.7rem;">admin</td>
                        <td style="padding: 0.7rem;">Admin User</td>
                        <td style="padding: 0.7rem;">admin@axero.com</td>
                        <td style="padding: 0.7rem;">Administrator</td>
                        <td style="padding: 0.7rem;">
                          <button class="btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
                        </td>
                      </tr>
                      <tr style="border-bottom: 1px solid var(--secondary);">
                        <td style="padding: 0.7rem;">user</td>
                        <td style="padding: 0.7rem;">Regular User</td>
                        <td style="padding: 0.7rem;">user@axero.com</td>
                        <td style="padding: 0.7rem;">User</td>
                        <td style="padding: 0.7rem;">
                          <button class="btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
                        </td>
                      </tr>
                      <tr style="border-bottom: 1px solid var(--secondary);">
                        <td style="padding: 0.7rem;">alex</td>
                        <td style="padding: 0.7rem;">Alex Johnson</td>
                        <td style="padding: 0.7rem;">alex@axero.com</td>
                        <td style="padding: 0.7rem;">User</td>
                        <td style="padding: 0.7rem;">
                          <button class="btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  <button class="btn-primary" onclick="openAddUserModal()">Add New User</button>
                </div>
                
                <div id="admin-system" style="display: none;">
                  <h3>System Settings</h3>
                  <div class="form-group">
                    <label>Site Title</label>
                    <input type="text" value="Axero Intranet Hub" />
                  </div>
                  <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" value="Axero Solutions" />
                  </div>
                  <div class="form-group">
                    <label>Default Theme</label>
                    <select>
                      <option value="light" selected>Light</option>
                      <option value="dark">Dark</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Session Timeout (minutes)</label>
                    <input type="number" value="60" min="5" max="1440" />
                  </div>
                  <button class="btn-primary">Save Settings</button>
                </div>
                
                <div id="admin-logs" style="display: block;">
                  <h3>Activity Logs</h3>
                  <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--secondary); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--secondary);">
                      <div><strong>Admin User</strong> logged in</div>
                      <div style="color: var(--text); opacity: 0.7;">${new Date().toLocaleString()}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--secondary);">
                      <div><strong>System</strong> database initialized</div>
                      <div style="color: var(--text); opacity: 0.7;">${new Date().toLocaleString()}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--secondary);">
                      <div><strong>Admin User</strong> viewed user profile</div>
                      <div style="color: var(--text); opacity: 0.7;">${new Date().toLocaleString()}</div>
                    </div>
                  </div>
                  <div style="display: flex; gap: 1rem;">
                    <button class="btn-secondary">Export Logs</button>
                    <button class="btn-danger">Clear Logs</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Add event listeners for admin panel tabs
        document.querySelectorAll('#admin-panel-modal button').forEach(btn => {
          btn.addEventListener('click', function() {
            if (this.getAttribute('onclick')?.includes('showAdminSection')) {
              const section = this.getAttribute('onclick').match(/showAdminSection\('([^']+)'\)/)[1];
              showAdminSection(section);
            }
          });
        });
      }
      
      // Show modal
      document.getElementById('admin-panel-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed('Accessed admin panel', 'admin-access');
    }
    
    // Show admin section
    function showAdminSection(section) {
      // Hide all sections
      document.querySelectorAll('#admin-content > div').forEach(div => {
        div.style.display = 'none';
      });
      
      // Show selected section
      document.getElementById(`admin-${section}`).style.display = 'block';
    }
    
    // User management functions with database storage
    let allUsers = [
      {
        username: 'admin',
        name: 'Admin User',
        email: 'admin@axero.com',
        role: 'Administrator',
        avatar: 'https://randomuser.me/api/portraits/men/1.jpg'
      },
      {
        username: 'user',
        name: 'Regular User',
        email: 'user@axero.com',
        role: 'User',
        avatar: 'https://randomuser.me/api/portraits/women/2.jpg'
      },
      {
        username: 'alex',
        name: 'Alex Johnson',
        email: 'alex@axero.com',
        role: 'User',
        avatar: 'https://randomuser.me/api/portraits/men/12.jpg'
      }
    ];
    
    // Initialize users in storage if not already there
    function initializeUsers() {
      const storedUsers = localStorage.getItem('axero_users');
      if (!storedUsers) {
        localStorage.setItem('axero_users', JSON.stringify(allUsers));
      } else {
        allUsers = JSON.parse(storedUsers);
      }
    }
    
    // Save users to storage
    function saveUsers() {
      localStorage.setItem('axero_users', JSON.stringify(allUsers));
    }
    
    // Open add user modal
    function openAddUserModal() {
      // Create modal if it doesn't exist
      if (!document.getElementById('add-user-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="add-user-modal">
            <div class="modal" style="width: 500px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('add-user-modal')">&times;</button>
              <h2>Add New User</h2>
              
              <form id="add-user-form" onsubmit="addNewUser(event)">
                <div class="form-group">
                  <label for="new-username">Username</label>
                  <input type="text" id="new-username" required />
                </div>
                
                <div class="form-group">
                  <label for="new-name">Full Name</label>
                  <input type="text" id="new-name" required />
                </div>
                
                <div class="form-group">
                  <label for="new-email">Email</label>
                  <input type="email" id="new-email" required />
                </div>
                
                <div class="form-group">
                  <label for="new-password">Password</label>
                  <input type="password" id="new-password" required />
                </div>
                
                <div class="form-group">
                  <label for="new-role">Role</label>
                  <select id="new-role" required>
                    <option value="User">User</option>
                    <option value="Administrator">Administrator</option>
                  </select>
                </div>
                
                <div class="form-actions">
                  <button type="button" class="btn-secondary" onclick="closeModal('add-user-modal')">Cancel</button>
                  <button type="submit" class="btn-primary">Create User</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      } else {
        // Reset form if modal exists
        document.getElementById('add-user-form').reset();
      }
      
      // Show modal
      document.getElementById('add-user-modal').classList.add('show');
    }
    
    // Add new user
    function addNewUser(event) {
      event.preventDefault();
      
      // Get form values
      const username = document.getElementById('new-username').value;
      const name = document.getElementById('new-name').value;
      const email = document.getElementById('new-email').value;
      const password = document.getElementById('new-password').value;
      const role = document.getElementById('new-role').value;
      
      // Check if username already exists
      if (allUsers.some(user => user.username === username)) {
        showNotification('Username already exists. Please choose a different username.', 'error');
        return;
      }
      
      // Generate random avatar
      const gender = Math.random() > 0.5 ? 'men' : 'women';
      const randomId = Math.floor(Math.random() * 99) + 1;
      const avatar = `https://randomuser.me/api/portraits/${gender}/${randomId}.jpg`;
      
      // Create new user
      const newUser = {
        username,
        name,
        email,
        role,
        avatar
      };
      
      // Add to users array
      allUsers.push(newUser);
      
      // Save to storage
      saveUsers();
      
      // Update users table
      updateUsersTable();
      
      // Close modal and show notification
      closeModal('add-user-modal');
      showNotification(`User ${username} created successfully!`, 'success');
      
      // Add to activity feed
      addToActivityFeed(`Created new user: ${username}`, 'user-create');
    }
    
    // Update users table
    function updateUsersTable() {
      const usersTableBody = document.querySelector('#admin-users table tbody');
      if (!usersTableBody) return;
      
      // Load latest users from storage
      initializeUsers();
      
      usersTableBody.innerHTML = allUsers.map(user => `
        <tr style="border-bottom: 1px solid var(--secondary);">
          <td style="padding: 0.7rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <img src="${user.avatar}" alt="${user.name}" style="width: 30px; height: 30px; border-radius: 50%;" />
              ${user.username}
            </div>
          </td>
          <td style="padding: 0.7rem;">${user.name}</td>
          <td style="padding: 0.7rem;">${user.email}</td>
          <td style="padding: 0.7rem;">
            <span style="padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.8rem; background: ${user.role === 'Administrator' ? '#ef4444' : '#3b82f6'}; color: white;">
              ${user.role}
            </span>
          </td>
          <td style="padding: 0.7rem;">
            <button class="btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="editUser('${user.username}')">Edit</button>
            ${user.username !== 'admin' ? `<button class="btn-danger" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;" onclick="deleteUser('${user.username}')">Delete</button>` : ''}
          </td>
        </tr>
      `).join('');
    }
    
    // Edit user
    function editUser(username) {
      const user = allUsers.find(u => u.username === username);
      if (!user) return;
      
      // Create modal if it doesn't exist
      if (!document.getElementById('edit-user-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="edit-user-modal">
            <div class="modal" style="width: 500px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('edit-user-modal')">&times;</button>
              <h2>Edit User</h2>
              
              <form id="edit-user-form" onsubmit="saveUserEdit(event)">
                <input type="hidden" id="edit-username" />
                
                <div class="form-group">
                  <label for="edit-name">Full Name</label>
                  <input type="text" id="edit-name" required />
                </div>
                
                <div class="form-group">
                  <label for="edit-email">Email</label>
                  <input type="email" id="edit-email" required />
                </div>
                
                <div class="form-group">
                  <label for="edit-password">New Password</label>
                  <input type="password" id="edit-password" placeholder="Leave blank to keep current password" />
                </div>
                
                <div class="form-group">
                  <label for="edit-role">Role</label>
                  <select id="edit-role" required>
                    <option value="User">User</option>
                    <option value="Administrator">Administrator</option>
                  </select>
                </div>
                
                <div class="form-actions">
                  <button type="button" class="btn-secondary" onclick="closeModal('edit-user-modal')">Cancel</button>
                  <button type="submit" class="btn-primary">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Populate form with user data
      document.getElementById('edit-username').value = user.username;
      document.getElementById('edit-name').value = user.name;
      document.getElementById('edit-email').value = user.email;
      document.getElementById('edit-role').value = user.role;
      
      // Show modal
      document.getElementById('edit-user-modal').classList.add('show');
    }
    
    // Save user edit
    function saveUserEdit(event) {
      event.preventDefault();
      
      const username = document.getElementById('edit-username').value;
      const name = document.getElementById('edit-name').value;
      const email = document.getElementById('edit-email').value;
      const password = document.getElementById('edit-password').value;
      const role = document.getElementById('edit-role').value;
      
      // Find user
      const userIndex = allUsers.findIndex(u => u.username === username);
      if (userIndex === -1) return;
      
      // Update user data
      allUsers[userIndex].name = name;
      allUsers[userIndex].email = email;
      allUsers[userIndex].role = role;
      
      // Save to storage
      saveUsers();
      
      // Update users table
      updateUsersTable();
      
      // Close modal and show notification
      closeModal('edit-user-modal');
      showNotification(`User ${username} updated successfully!`, 'success');
      
      // Add to activity feed
      addToActivityFeed(`Updated user: ${username}`, 'user-update');
    }
    
    // Delete user
    function deleteUser(username) {
      // Don't allow deleting admin
      if (username === 'admin') {
        showNotification('Cannot delete admin user', 'error');
        return;
      }
      
      // Confirm deletion
      if (!confirm(`Are you sure you want to delete user ${username}?`)) {
        return;
      }
      
      // Remove user
      const userIndex = allUsers.findIndex(u => u.username === username);
      if (userIndex === -1) return;
      
      allUsers.splice(userIndex, 1);
      
      // Save to storage
      saveUsers();
      
      // Update users table
      updateUsersTable();
      
      // Show notification
      showNotification(`User ${username} deleted successfully!`, 'success');
      
      // Add to activity feed
      addToActivityFeed(`Deleted user: ${username}`, 'user-delete');
    }
    
    // Notice Board functionality
    let noticeBoard = [];
    
    // Initialize notice board
    function initializeNoticeBoard() {
      const storedNotices = localStorage.getItem('axero_notices');
      if (storedNotices) {
        noticeBoard = JSON.parse(storedNotices);
      } else {
        // Default notices
        noticeBoard = [
          {
            id: 1,
            title: 'Company Picnic',
            content: 'Annual company picnic scheduled for August 15th at Golden Gate Park. All employees and families welcome!',
            author: 'HR Team',
            date: '2025-07-05',
            priority: 'medium',
            color: '#3b82f6'
          },
          {
            id: 2,
            title: 'System Maintenance',
            content: 'IT systems will be down for maintenance on July 12th from 10 PM to 2 AM. Please save your work before leaving on Friday.',
            author: 'IT Department',
            date: '2025-07-08',
            priority: 'high',
            color: '#ef4444'
          },
          {
            id: 3,
            title: 'New Benefits Package',
            content: 'We\'re excited to announce our enhanced benefits package starting next quarter. Details available in the HR portal.',
            author: 'Benefits Team',
            date: '2025-07-01',
            priority: 'low',
            color: '#10b981'
          }
        ];
        saveNoticeBoard();
      }
      renderNoticeBoard();
    }
    
    // Save notice board to storage
    function saveNoticeBoard() {
      localStorage.setItem('axero_notices', JSON.stringify(noticeBoard));
    }
    
    // Render notice board
    function renderNoticeBoard() {
      const noticeBoardElement = document.getElementById('notice-board');
      if (!noticeBoardElement) return;
      
      if (noticeBoard.length === 0) {
        noticeBoardElement.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; background: var(--secondary); border-radius: var(--radius);">
            <div style="font-size: 2rem; margin-bottom: 1rem;">📌</div>
            <h3>No Announcements</h3>
            <p>There are no announcements on the notice board yet.</p>
            <button class="btn-primary" onclick="openAddAnnouncementModal()">Add First Announcement</button>
          </div>
        `;
        return;
      }
      
      // Sort by date (newest first) and priority
      const sortedNotices = [...noticeBoard].sort((a, b) => {
        const priorityWeight = { high: 3, medium: 2, low: 1 };
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        
        // First sort by priority
        if (priorityWeight[a.priority] !== priorityWeight[b.priority]) {
          return priorityWeight[b.priority] - priorityWeight[a.priority];
        }
        
        // Then by date
        return dateB - dateA;
      });
      
      noticeBoardElement.innerHTML = sortedNotices.map(notice => `
        <div 
          onclick="viewNotice(${notice.id})" 
          style="
            background: var(--card); 
            border-left: 5px solid ${notice.color}; 
            padding: 1rem; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s ease;
          "
          onmouseover="this.style.transform='translateY(-3px)';"
          onmouseout="this.style.transform='translateY(0)';"
        >
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <h3 style="margin: 0; color: var(--primary);">${notice.title}</h3>
            <span style="
              background: ${notice.color}; 
              color: white; 
              padding: 0.2rem 0.5rem; 
              border-radius: 1rem; 
              font-size: 0.8rem;
            ">
              ${notice.priority.charAt(0).toUpperCase() + notice.priority.slice(1)}
            </span>
          </div>
          <p style="margin: 0.5rem 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
            ${notice.content}
          </p>
          <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text); opacity: 0.7; margin-top: 0.5rem;">
            <div>${notice.author}</div>
            <div>${new Date(notice.date).toLocaleDateString()}</div>
          </div>
        </div>
      `).join('');
    }
    
    // Open add announcement modal
    function openAddAnnouncementModal() {
      // Create modal if it doesn't exist
      if (!document.getElementById('add-announcement-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="add-announcement-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('add-announcement-modal')">&times;</button>
              <h2>Add Announcement</h2>
              
              <form id="add-announcement-form" onsubmit="addAnnouncement(event)">
                <div class="form-group">
                  <label for="announcement-title">Title</label>
                  <input type="text" id="announcement-title" required />
                </div>
                
                <div class="form-group">
                  <label for="announcement-content">Content</label>
                  <textarea id="announcement-content" rows="5" required></textarea>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="announcement-author">Author/Department</label>
                    <input type="text" id="announcement-author" required />
                  </div>
                  
                  <div class="form-group">
                    <label for="announcement-priority">Priority</label>
                    <select id="announcement-priority" required>
                      <option value="low">Low</option>
                      <option value="medium" selected>Medium</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-actions">
                  <button type="button" class="btn-secondary" onclick="closeModal('add-announcement-modal')">Cancel</button>
                  <button type="submit" class="btn-primary">Post Announcement</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      } else {
        // Reset form if modal exists
        document.getElementById('add-announcement-form').reset();
      }
      
      // Show modal
      document.getElementById('add-announcement-modal').classList.add('show');
    }
    
    // Add announcement
    function addAnnouncement(event) {
      event.preventDefault();
      
      // Get form values
      const title = document.getElementById('announcement-title').value;
      const content = document.getElementById('announcement-content').value;
      const author = document.getElementById('announcement-author').value;
      const priority = document.getElementById('announcement-priority').value;
      
      // Set color based on priority
      let color = '#3b82f6'; // Default blue
      if (priority === 'high') color = '#ef4444'; // Red
      if (priority === 'low') color = '#10b981'; // Green
      
      // Create new announcement
      const newAnnouncement = {
        id: Date.now(),
        title,
        content,
        author,
        date: new Date().toISOString().split('T')[0],
        priority,
        color
      };
      
      // Add to notice board
      noticeBoard.push(newAnnouncement);
      
      // Save to storage
      saveNoticeBoard();
      
      // Update notice board
      renderNoticeBoard();
      
      // Close modal and show notification
      closeModal('add-announcement-modal');
      showNotification(`Announcement "${title}" posted successfully!`, 'success');
      
      // Add to activity feed
      addToActivityFeed(`Posted announcement: ${title}`, 'announcement-create');
    }
    
    // View notice
    function viewNotice(noticeId) {
      const notice = noticeBoard.find(n => n.id === noticeId);
      if (!notice) return;
      
      // Create modal if it doesn't exist
      if (!document.getElementById('view-notice-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="view-notice-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('view-notice-modal')">&times;</button>
              <div id="view-notice-content"></div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Generate content
      const content = `
        <div style="border-left: 5px solid ${notice.color}; padding-left: 1rem;">
          <h2 style="margin-top: 0; color: var(--primary);">${notice.title}</h2>
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <div>Posted by: <strong>${notice.author}</strong></div>
            <div>Date: ${new Date(notice.date).toLocaleDateString()}</div>
          </div>
        </div>
        
        <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin: 1.5rem 0;">
          <p style="white-space: pre-line;">${notice.content}</p>
        </div>
        
        <div class="form-actions">
          <button class="btn-secondary" onclick="closeModal('view-notice-modal')">Close</button>
          ${currentUser && currentUser.role === 'Administrator' ? `
            <button class="btn-primary" onclick="editNotice(${notice.id})">Edit</button>
            <button class="btn-danger" onclick="deleteNotice(${notice.id})">Delete</button>
          ` : ''}
        </div>
      `;
      
      // Update and show modal
      document.getElementById('view-notice-content').innerHTML = content;
      document.getElementById('view-notice-modal').classList.add('show');
      
      // Add to activity feed
      addToActivityFeed(`Viewed announcement: ${notice.title}`, 'announcement-view');
    }
    
    // Edit notice
    function editNotice(noticeId) {
      const notice = noticeBoard.find(n => n.id === noticeId);
      if (!notice) return;
      
      // Create modal if it doesn't exist
      if (!document.getElementById('edit-notice-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="edit-notice-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('edit-notice-modal')">&times;</button>
              <h2>Edit Announcement</h2>
              
              <form id="edit-notice-form" onsubmit="saveNoticeEdit(event)">
                <input type="hidden" id="edit-notice-id" />
                
                <div class="form-group">
                  <label for="edit-notice-title">Title</label>
                  <input type="text" id="edit-notice-title" required />
                </div>
                
                <div class="form-group">
                  <label for="edit-notice-content">Content</label>
                  <textarea id="edit-notice-content" rows="5" required></textarea>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="edit-notice-author">Author/Department</label>
                    <input type="text" id="edit-notice-author" required />
                  </div>
                  
                  <div class="form-group">
                    <label for="edit-notice-priority">Priority</label>
                    <select id="edit-notice-priority" required>
                      <option value="low">Low</option>
                      <option value="medium">Medium</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-actions">
                  <button type="button" class="btn-secondary" onclick="closeModal('edit-notice-modal')">Cancel</button>
                  <button type="submit" class="btn-primary">Update Announcement</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // Populate form with notice data
      document.getElementById('edit-notice-id').value = notice.id;
      document.getElementById('edit-notice-title').value = notice.title;
      document.getElementById('edit-notice-content').value = notice.content;
      document.getElementById('edit-notice-author').value = notice.author;
      document.getElementById('edit-notice-priority').value = notice.priority;
      
      // Close view modal and show edit modal
      closeModal('view-notice-modal');
      document.getElementById('edit-notice-modal').classList.add('show');
    }
    
    // Save notice edit
    function saveNoticeEdit(event) {
      event.preventDefault();
      
      const id = parseInt(document.getElementById('edit-notice-id').value);
      const title = document.getElementById('edit-notice-title').value;
      const content = document.getElementById('edit-notice-content').value;
      const author = document.getElementById('edit-notice-author').value;
      const priority = document.getElementById('edit-notice-priority').value;
      
      // Set color based on priority
      let color = '#3b82f6'; // Default blue
      if (priority === 'high') color = '#ef4444'; // Red
      if (priority === 'low') color = '#10b981'; // Green
      
      // Find notice
      const noticeIndex = noticeBoard.findIndex(n => n.id === id);
      if (noticeIndex === -1) return;
      
      // Update notice data
      noticeBoard[noticeIndex] = {
        ...noticeBoard[noticeIndex],
        title,
        content,
        author,
        priority,
        color
      };
      
      // Save to storage
      saveNoticeBoard();
      
      // Update notice board
      renderNoticeBoard();
      
      // Close modal and show notification
      closeModal('edit-notice-modal');
      showNotification(`Announcement "${title}" updated successfully!`, 'success');
      
      // Add to activity feed
      addToActivityFeed(`Updated announcement: ${title}`, 'announcement-update');
    }
    
    // Delete notice
    function deleteNotice(noticeId) {
      // Confirm deletion
      if (!confirm('Are you sure you want to delete this announcement?')) {
        return;
      }
      
      const notice = noticeBoard.find(n => n.id === noticeId);
      if (!notice) return;
      
      // Remove notice
      const noticeIndex = noticeBoard.findIndex(n => n.id === noticeId);
      if (noticeIndex === -1) return;
      
      noticeBoard.splice(noticeIndex, 1);
      
      // Save to storage
      saveNoticeBoard();
      
      // Update notice board
      renderNoticeBoard();
      
      // Close modal and show notification
      closeModal('view-notice-modal');
      showNotification(`Announcement "${notice.title}" deleted successfully!`, 'success');
      
      // Add to activity feed
      addToActivityFeed(`Deleted announcement: ${notice.title}`, 'announcement-delete');
    }
    
    // Initialize the application with database setup and data loading
    async function initializeApp() {
      try {
        // Initialize the database
        await initDatabase();
        
        // Initialize sample data
        await initializeSampleData();
        
        // Load all data from database
        await loadDevicesFromDB();
        await loadCalendarEvents();
        await loadChatMessages();
        await renderActivityFeed();
        await updateDeviceStats();
        
        // Initialize users
        initializeUsers();
        
        // Initialize notice board
        initializeNoticeBoard();
        
        // Setup role-based access control
        setupRoleBasedAccess();
        
        console.log('Application initialized successfully with IndexedDB');
      } catch (error) {
        console.error('Failed to initialize application:', error);
        showNotification('⚠️ Failed to initialize database. Some features may not work properly.', 'error');
      }
    }
    
    // Start the application
    initializeApp();
    
    // Screenshot functionality
    let screenshotStartX = 0;
    let screenshotStartY = 0;
    let isSelecting = false;
    
    function startScreenshot() {
      document.getElementById('screenshot-overlay').style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent scrolling while selecting
      
      // Add to activity feed
      addToActivityFeed('Started screenshot tool', 'screenshot-start');
    }
    
    function cancelScreenshot() {
      document.getElementById('screenshot-overlay').style.display = 'none';
      document.getElementById('screenshot-selection').style.display = 'none';
      document.body.style.overflow = '';
      isSelecting = false;
    }
    
    // Set up screenshot event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const overlay = document.getElementById('screenshot-overlay');
      const selection = document.getElementById('screenshot-selection');
      
      // Cancel screenshot with Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && overlay.style.display === 'block') {
          cancelScreenshot();
        }
      });
      
      // Handle mouse events for selection
      overlay.addEventListener('mousedown', function(e) {
        isSelecting = true;
        screenshotStartX = e.clientX;
        screenshotStartY = e.clientY;
        selection.style.left = screenshotStartX + 'px';
        selection.style.top = screenshotStartY + 'px';
        selection.style.width = '0';
        selection.style.height = '0';
        selection.style.display = 'block';
      });
      
      overlay.addEventListener('mousemove', function(e) {
        if (!isSelecting) return;
        
        const currentX = e.clientX;
        const currentY = e.clientY;
        
        // Calculate dimensions and position
        const width = Math.abs(currentX - screenshotStartX);
        const height = Math.abs(currentY - screenshotStartY);
        const left = Math.min(currentX, screenshotStartX);
        const top = Math.min(currentY, screenshotStartY);
        
        // Update selection box
        selection.style.width = width + 'px';
        selection.style.height = height + 'px';
        selection.style.left = left + 'px';
        selection.style.top = top + 'px';
      });
      
      overlay.addEventListener('mouseup', function() {
        if (!isSelecting) return;
        isSelecting = false;
        
        // Check if selection is too small
        const width = parseInt(selection.style.width);
        const height = parseInt(selection.style.height);
        
        if (width < 50 || height < 50) {
          showNotification('Selection area too small. Please select a larger area.', 'warning');
          cancelScreenshot();
          return;
        }
        
        // Simulate screenshot capture
        setTimeout(() => {
          showNotification('Screenshot captured! You can now share or download it.', 'success');
          openScreenshotModal();
          cancelScreenshot();
          
          // Add to activity feed
          addToActivityFeed('Captured a screenshot of the intranet', 'screenshot-capture');
        }, 300);
      });
    });
    
    function openScreenshotModal() {
      // Create modal if it doesn't exist
      if (!document.getElementById('screenshot-modal')) {
        const modalHTML = `
          <div class="modal-overlay" id="screenshot-modal">
            <div class="modal" style="width: 600px; max-width: 90vw;">
              <button class="modal-close" onclick="closeModal('screenshot-modal')">&times;</button>
              <h2>Screenshot Captured</h2>
              <div id="screenshot-modal-content">
                <div style="background: var(--secondary); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                  <p>Your screenshot has been captured successfully!</p>
                  <div style="background: #f0f0f0; height: 300px; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem;">
                    <div style="text-align: center;">
                      <div style="font-size: 3rem; margin-bottom: 1rem;">📸</div>
                      <div>Screenshot Preview</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="screenshot-name">Screenshot Name</label>
                  <input type="text" id="screenshot-name" value="Axero Intranet Screenshot - ${new Date().toLocaleDateString()}" />
                </div>
                
                <div class="form-actions">
                  <button class="btn-secondary" onclick="closeModal('screenshot-modal')">Close</button>
                  <button class="btn-primary" onclick="showNotification('Screenshot downloaded successfully!', 'success'); closeModal('screenshot-modal');">Download</button>
                  <button class="btn-primary" onclick="showNotification('Screenshot copied to clipboard!', 'success'); closeModal('screenshot-modal');">Copy to Clipboard</button>
                  <button class="btn-primary" onclick="openMessageComposer(); document.getElementById('message-subject').value = 'Screenshot Sharing'; closeModal('screenshot-modal');">Share via Message</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      document.getElementById('screenshot-modal').classList.add('show');
    }
    
    // Welcome user with comprehensive initial notification that includes location-based weather
    function showWelcomeNotification() {
      // Default weather info in case geolocation fails
      let weatherInfo = `🌤️ Weather data loading...`;
      
      // If we already have weather data, use it
      if (document.getElementById('weather-temp').textContent) {
        const temp = document.getElementById('weather-temp').textContent;
        const desc = document.getElementById('weather-desc').textContent;
        const icon = document.getElementById('weather-icon').textContent;
        weatherInfo = `${icon} ${temp} - ${desc} in ${userLocation.city}`;
      }
      
      // Count announcements
      const announcementCount = noticeBoard ? noticeBoard.length : 5;
      
      // Count upcoming events
      let upcomingEventCount = 0;
      const today = new Date();
      for (let i = 0; i < 30; i++) {
        const date = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const dayEvents = calendarEvents[dateStr] || [];
        upcomingEventCount += dayEvents.length;
      }
      
      // Count online users
      const onlineUsers = allUsers ? allUsers.length : 128;
      
      showNotification(`🎉 Welcome to Axero Intranet, ${currentUser ? currentUser.name : 'User'}!<br><br>
        📋 ${announcementCount} announcements • ${upcomingEventCount} upcoming events<br>
        ${weatherInfo} • ${onlineUsers} users online<br><br>
        💡 Pro tip: Press Ctrl+K to search anything!`, 'success');
    }
    
    // Show welcome notification after a delay
    setTimeout(() => {
      // If weather data is already loaded, show notification immediately
      if (document.getElementById('weather-temp').textContent) {
        showWelcomeNotification();
      } else {
        // Otherwise wait for weather data to load
        const weatherObserver = new MutationObserver((mutations) => {
          if (document.getElementById('weather-temp').textContent) {
            showWelcomeNotification();
            weatherObserver.disconnect();
          }
        });
        
        weatherObserver.observe(document.getElementById('weather-temp'), { childList: true });
        
        // Fallback in case weather data doesn't load
        setTimeout(() => {
          if (!document.getElementById('weather-temp').textContent) {
            showWelcomeNotification();
            weatherObserver.disconnect();
          }
        }, 5000);
      }
    }, 1000);
  </script>
</body>
</html>
